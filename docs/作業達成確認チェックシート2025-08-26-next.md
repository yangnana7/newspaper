最新の master ブランチのコードとドキュメントを確認した結果をまとめ、今後の作業指示と進捗チェックシートを作成しました。

---

## 1. master ブランチのレビュー

### 追加・更新内容の概要

* **エンティティ抽出機能**
  `scripts/entity_link.py` に spaCy を利用した日本語NER（利用可能な場合）と、カタカナ連続語や3文字以上の漢字を検出するフォールバック正規表現が実装されました。
  `scripts/ingest_entities.py` では `extract_entities()` を使って `chunk` 表から抽出したエンティティを `entity` 表に登録し、`mention` 表に紐付けています。
* **イベント抽出機能**
  `scripts/event_extract.py` では YYYY/MM/DD や「8月24日」形式の日付を検出し、イベント辞書を返す簡易実装が追加されています。
  `scripts/ingest_events.py` は `extract_events()` から得たイベントを `event` 表へ登録し、同じ `chunk` に属するドキュメントを `evidence` 表で紐付ける処理を追加しています。
* **ランキング機構の言語対応**
  `config/ranking.yaml` に `language` ウェイトと `language_trust` セクションが追加され、日本語(ja)・英語(en)・中国語(zh)の信頼度が定義されました。
  `search/ranker.py` では `language_index` パラメータを追加し、スコア計算に言語重みを取り入れるよう拡張されています。
  `mcp_news/server.py` と `web/app.py` は `SELECT` に `d.lang` を含め、`rerank_candidates` 呼び出しに `language_index=6` を渡しています。
* **新ツール `event_timeline`**
  `mcp_news/server.py` にイベント時系列を取得する `event_timeline` ツールが実装され、`filter` に `type_id`・期間・エンティティIDを指定してイベント一覧を取得できるようになりました。
* **CI/テスト拡充**
  `tests/test_entity_extraction.py` や `tests/test_event_extraction.py` などが追加され、エンティティ・イベント抽出の最低限の動作を検証しています。
  また、`tests/test_language_trust.py` で `score_weights` に `language` キーが含まれ、合計1.0になることを確認しています。

### 評価

* **進捗**: エンティティ・イベント抽出とランキング言語対応の初期実装が完了し、新しい ingestion スクリプトや API ツールが追加されました。CI も緑で通っており、基本的な品質は確保されています。
* **良い点**: NER未インストール環境でもフォールバックで抽出できる設計や、DB接続をインポート時に行わない工夫、新しい `event_timeline` ツールなど、拡張性を意識した実装となっています。
* **懸念点・改善案**:

  1. **エンティティ重複**: `ingest_entities.py` は `entity` への `INSERT` に重複チェックが無く、同じ名前のエンティティが複数登録される恐れがあります。`attrs->>'name'` に一意制約を設けるか、`ON CONFLICT` による upsert 処理が必要です。
  2. **外部ID連携が未実装**: 現状は `ext_id` が `NULL` のままであり、Wikidata等へのリンクが未対応です。
  3. **イベント詳細が限定的**: 抽出対象は日付のみで、場所や参加者は含まれていません。`event_timeline` でも `event` 表の基本情報しか返さないため、次の段階として参加者・場所・関連ドキュメントを含めた詳細化が望まれます。
  4. **NERモデルの依存管理**: spaCyモデル `ja_core_news_sm` を読み込む処理があるものの、`requirements-dev.txt` には spacy の記述がなく、CIや本番環境でモデルが利用できない可能性があります。必要に応じて依存追加やモデルダウンロード手順を整備してください。

---

## 2. 次の作業指示書（2025‑08‑27 以降）

以下は、現在の到達点から「機械可読の報道基盤」としての完成度を高めるための指示書です。すべての作業は **DB名は newshub／ポートは127.0.0.1:3011／ベクトル距離はcosine／UI既定無効** という固定ルールに従い、意図せぬ環境変更を行わないようにしてください。

### A) エンティティの外部リンクと重複対策

1. **DB制約の追加**

   * `entity` テーブルに `UNIQUE (attrs->>'name')` 制約を追加（既存重複がある場合はマイグレーションで統合）。
   * `ext_id` に対しても `UNIQUE` 制約を設ける。
2. **Wikidata連携スクリプト**

   * 新規: `scripts/link_entities_wikidata.py` を作成。
   * `entity` 表で `ext_id` が `NULL` の行を対象に、Wikidata API（例: `https://www.wikidata.org/w/api.php?action=wbsearchentities&search={name}&language=ja&format=json`）を呼び出して QID を取得。
   * 信頼度の高い一致が得られた場合、`entity.ext_id` と `entity.kind`、`entity.type_id` を更新する。
   * ネットワークエラー時にはリトライし、APIの回数制限に配慮。
   * スクリプト実行後、更新件数を表示。
3. **アップサート処理への改善**

   * `scripts/ingest_entities.py` を修正し、`INSERT INTO entity ... ON CONFLICT (attrs->>'name') DO UPDATE ...` の形式で重複を避ける。
   * 既存レコードがある場合はその `ent_id` を取得し、`mention` に追加する。
4. **テスト**

   * 新規: `tests/test_entity_linking.py`。
   * Wikidataへの外部呼び出しはモック（pytest `monkeypatch` や `responses`）で置き換え、`link_entities_wikidata.py` が ext\_id を正しく設定するか検証。
   * `UNIQUE` 制約違反が起こらないこと、`ingest_entities.py` が同じ名前で複数行を生成しないことを確認する。

### B) イベント抽出の詳細化

1. **参加者・場所抽出**

   * `scripts/event_extract.py` を拡張し、`extract_entities()` を再利用してイベント内の人名・組織名を `participants` に含める。
   * 地名・場所に対しては簡易的に都道府県名や主要都市名を辞書で判定し、GeoHash (例: 9q8yy, 9q8yw) に変換して `loc_geohash` に設定（辞書に無い場合は `None`）。
   * `type_id` は設計メモの分類案（会見/会合/災害/裁判…）を参考に、キーワードに基づき分類する簡易ロジックを組み込む。
2. **イベント参加者の登録**

   * `scripts/ingest_events.py` を修正。`extract_events()` が返す `participants` を参照してエンティティ表から該当者を検索（なければ登録）、`event_participant` に `role` を `NULL` あるいは暫定文字列で挿入する。
   * `loc_geohash` を `event` の `loc_geohash` 列に格納する。
   * 既存イベントが同一記事に対して重複登録されないよう、`event` と `chunk_id` の組み合わせで `ON CONFLICT` 制御を検討。
3. **テスト**

   * 新規: `tests/test_event_participants.py`。
   * 例文から参加者名が抽出され、`event_participant` に登録されること、`loc_geohash` が適切に設定されることをチェックする。DBを使うテストは `SKIP_DB_TESTS` を尊重する。

### C) `event_timeline` API の拡張

1. **APIの出力項目追加**

   * `mcp_news/server.py` の `event_timeline` を改良し、各イベントに `participants`（ext\_idと名前のリスト）および `doc_ids`（関連ドキュメントIDのリスト）を含めて返すようにする。
   * イベントタイプ名称（`type_id`→文字列）を返す場合は、別途定義したマッピングを使用。
2. **フィルタの強化**

   * `filter` に `participant_ext_id`（参加者の ext\_id）や `loc_geohash` を受け付けるように拡張し、`WHERE` 句を組み立てる。
3. **テスト**

   * 新規: `tests/test_event_timeline_api.py`。
   * モックデータベースまたは `SKIP_DB_TESTS=0` 環境下で、参加者・期間・タイプ別のフィルタが意図通りに作用することを検証。

### D) 言語判定とランキング精緻化

1. **言語判定ライブラリ**

   * `langdetect` や `fasttext` を導入し、取り込む記事ごとに `doc.lang` を自動設定するスクリプト `scripts/set_language.py` を作成。
   * 日本語・英語・中国語以外も検出し、`language_trust` で重み付け可能なよう `config/ranking.yaml` に追記する（初期値は低め）。
2. **テスト**

   * 新規: `tests/test_language_detection.py`。
   * 簡単な文がそれぞれ適切な言語コードに判定されること、未知言語の場合は `None` になることを確認。

### E) ドキュメント・CI整備

1. **ドキュメント更新**

   * `docs/design/entity_event_plan.md` に外部ID連携・参加者抽出・場所抽出・言語判定のアルゴリズム概要を追記。
   * `docs/ops/metrics.md` に新たに追加するメトリクス（例: `entities_linked_total`, `events_with_participants_total`）の説明を追加。
   * `docs/daily/2025-08-27.md` で本指示書の概要、追加ファイル一覧、注意点を記録。
2. **CIの更新**

   * 必要なライブラリ（`langdetect`, `spacy`, `geohash2`, `requests` など）を `requirements-dev.txt` に追記し、`ja_core_news_sm` モデルが必要な場合はダウンロード手順を CI に追加。
   * DBを必要とするテスト (`SKIP_DB_TESTS=0`) は別ジョブに分け、PostgreSQL（pgvector付き）をサービスとして起動するワークフローを準備する。

---

## 3. 進捗状況チェックシート（2025‑08‑27用）

| No | チェック項目                                | コマンド例・エビデンス                                                                                         | 期待値                   | 重み(%) | 状態   |
| -- | ------------------------------------- | --------------------------------------------------------------------------------------------------- | --------------------- | ----: | ---- |
| 1  | `entity` に UNIQUE 制約追加                | `\d+ entity` (psql)                                                                                 | name 属性に unique index |     7 | \[ ] |
| 2  | Wikidata 連携スクリプト作成                    | `test -f scripts/link_entities_wikidata.py && echo OK`                                              | `OK`                  |     8 | \[ ] |
| 3  | `ingest_entities.py` の upsert化        | `grep -q "ON CONFLICT" scripts/ingest_entities.py && echo OK`                                       | `OK`                  |     5 | \[ ] |
| 4  | `tests/test_entity_linking.py` 成功     | `pytest -q tests/test_entity_linking.py`                                                            | 0 failed              |    10 | \[ ] |
| 5  | 参加者・場所抽出実装                            | `grep -q "participants" scripts/event_extract.py && grep -q "loc_geohash" scripts/event_extract.py` | 2箇所ヒット                |     7 | \[ ] |
| 6  | イベント登録スクリプト更新                         | `grep -q "event_participant" scripts/ingest_events.py`                                              | ヒット                   |     7 | \[ ] |
| 7  | `tests/test_event_participants.py` 成功 | `pytest -q tests/test_event_participants.py`                                                        | 0 failed              |    10 | \[ ] |
| 8  | `event_timeline` 拡張反映                 | `grep -q "participants" mcp_news/server.py`                                                         | ヒット                   |     7 | \[ ] |
| 9  | `tests/test_event_timeline_api.py` 成功 | `pytest -q tests/test_event_timeline_api.py`                                                        | 0 failed              |    10 | \[ ] |
| 10 | 言語判定スクリプト作成                           | `test -f scripts/set_language.py && echo OK`                                                        | `OK`                  |     5 | \[ ] |
| 11 | `tests/test_language_detection.py` 成功 | `pytest -q tests/test_language_detection.py`                                                        | 0 failed              |     6 | \[ ] |
| 12 | ドキュメント更新                              | `git ls-files docs/daily/2025-08-27.md docs/design/entity_event_plan.md`                            | パス表示                  |     5 | \[ ] |
| 13 | CI依存追加                                | `grep -q 'langdetect' requirements-dev.txt`                                                         | ヒット                   |     5 | \[ ] |
| 14 | CI分割ジョブ設定                             | `grep -q 'services:' .github/workflows/ci-db.yml`                                                   | ヒット                   |     5 | \[ ] |
| 15 | 固定ポリシー維持確認                            | `pytest -q tests/test_ci_env.py`                                                                    | 0 failed              |     5 | \[ ] |

進捗率は、達成済みの項目の重み合計で算出してください。

---

この指示書を CodexCLI に貼り付ければ、エンティティの外部リンク・イベントの詳細化・言語判定などを含む次のステップに進めます。必要に応じて `docs/daily/2025-08-27.md` に作業記録を残しながら、機能の完成度を高めていきましょう。
