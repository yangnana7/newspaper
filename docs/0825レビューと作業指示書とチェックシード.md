# 進捗サマリ（8/25 JST 現在）

* master へマージ済み（言語コード正規化の実装＋回帰テスト追加）。
* CI の「runner.temp 参照」問題は撤廃済み（`/tmp/linking.progress` 固定）。
* 直近ログでの赤要因は “短文の漢字で `ko` 誤判定” をヒューリスティックで吸収することで解消済み想定。
  👉 念のため **最初のタスク**で `pytest -q` を回し、完全グリーンを確認してから先へ進みます。

---

# 次の作業指示書

> 前提: Ubuntu 24.04 / Python 3.11+ / PostgreSQL 16（pgvector）/ リポジトリ直下

## T0. CIグリーン確認（必須・最初に実施）

```
# 依存復元
python -m venv .venv && source .venv/bin/activate
pip install -U pip && pip install -r requirements.txt

# 単体テスト
pytest -q
```

**期待**: 全テスト pass（skip は許容）。失敗があればログ全文を貼って再実装。

---

## T1. pgvector HNSW インデックスの常設化（検索高速化）

**目的**: `chunk_vec` に HNSW を張ってセマンティック検索を加速。
**実装**:

1. `db/indexes_core.sql` を新規追加（または更新）

```
-- pgvector 0.5+ / PostgreSQL 16 想定
CREATE INDEX IF NOT EXISTS ix_chunk_vec_bge_m3_hnsw
ON chunk_vec USING hnsw (emb vector_cosine_ops)
WHERE embedding_space='bge-m3';
```

2. 反映用スクリプトを追加: `scripts/db_ensure_indexes.py`

   * 役割: `psycopg` で `indexes_core.sql` を流すだけ。
3. CI に “索引チェック” ステップ追加（存在しなければ fail）。

**確認**:

```
psql "$DATABASE_URL" -c "\d+ chunk_vec" | rg hnsw
```

出力に `ix_chunk_vec_bge_m3_hnsw` が見えること。

---

## T2. ランク融合の外部設定化（重みをファイルで可変に）

**目的**: cos類似 × 新鮮度 × ソース信頼度を TOML/JSONの設定で調整可能に。
**実装**:

1. `config/ranking.toml` を新規:

```
alpha = 0.7   # cos
beta  = 0.2   # recency
gamma = 0.1   # source_trust
half_life_hours = 48
```

2. `search/ranker.py` の `rerank_candidates(...)` で上記設定を読み込む（存在しない場合はデフォルト）。
3. **単体テスト** `tests/test_ranking_config.py`

   * 設定の読み込みと、Δt が小さいほどスコアが上がる単調性を検証。

**確認**:

```
pytest -q tests/test_ranking_config.py -q
```

---

## T3. MCP ツール I/F の堅牢化（例外・空結果・since フィルタ）

**目的**: `mcp_news.server` の `semantic_search` / `entity_search` で例外時フォールバックと since フィルタの境界条件を強化。
**実装**:

* `since` のパース失敗で落ちないようにし、**recency fallback** に確実に切替。
* 空 DB のときも空配列を返す。
* ログに `q`, `top_k`, `since_iso`, 実走クエリ種別（vec or recency）を info で出力。
* 既存 `metrics.get_metrics_content()` があれば、検索リクエストカウンタを追加。

**確認**:

```
python -m mcp_news.server &   # stdio/HTTPどちらでも可
# 別シェル:
python - <<'PY'
from mcp_news.server import semantic_search
print(semantic_search("test", top_k=5, since="2025-08-01T00:00:00Z"))
PY
```

---

## T4. 取り込み・埋め込みの systemd 常駐化（本番運用形）

**目的**: `deploy/*.service|*.timer` を現行パスに合わせ、定期実行を安定運用。
**実装**:

* `deploy/ingest.service|timer`, `deploy/embed.service|timer`, `mcp-news.service` の WorkingDirectory と venv パスを `/opt/mcp-news` に置換（サンプルがあればそれを流用）。
* `deploy/README.md` を追加し、`sudo systemctl enable --now ...` の手順を明文化。

**確認**:

```
sudo systemctl list-timers | rg -E 'ingest|embed'
journalctl -u ingest.service -n 50 --no-pager
```

---

## T5. 近重複クラスタの最小実装（タイトル中心 / URL正規化済み）

**目的**: 同一事件の多面記事を束ねる土台。
**実装**:

* `search/near_duplicate.py` を新規（SimHash + MinHash の軽量版）。
* `scripts/cluster_duplicates.py` が `dup_cluster_id` を `doc` または別テーブルに書く。
* 最低限の単体テストを追加（人工データでクラスタ分割を検証）。

**確認**:

```
pytest -q tests/test_near_duplicate.py -q
```

---

## T6. Prometheus メトリクスの拡充

**目的**: 運用可視化（ingest件数、vec作成レイテンシ、dup率）。
**実装**:

* `mcp_news/metrics.py` に `items_ingested_total`, `embed_latency_seconds`, `dup_ratio` を追加。
* FastAPI/Starlette で `/metrics` を公開（UI無効でもOK）。

**確認**:

```
curl -s http://127.0.0.1:3011/metrics | head
```

---

# 作業達成確認チェックシード（実行順）

* [ ] **T0**: `pytest -q` 全緑
* [ ] **T1**: `\d+ chunk_vec` に HNSW インデックス表示
* [ ] **T2**: `tests/test_ranking_config.py` 緑、`config/ranking.toml` 変更で挙動が変わる
* [ ] **T3**: `semantic_search("test", since="bad")` が例外なく空配列または recency フォールバック
* [ ] **T4**: `systemctl list-timers` で ingest/embed 稼働、`journalctl` に成功ログ
* [ ] **T5**: `tests/test_near_duplicate.py` 緑、`dup_cluster_id` が付与される
* [ ] **T6**: `/metrics` に新メトリクス 3 種が出力される

> すべて済んだら `git commit -m "MVP harden: HNSW + rank cfg + metrics + dup clustering"` → push。

---

# マイルストーン（提案・JST）

**M1: 検索MVP完成（8/26–8/27）**

* T0–T3 完了
* 受入: `semantic_search` 50件/クエリで < 700ms（HNSW前提・開発機）

**M2: 運用MVP（8/28）**

* T4 完了（ingest/embed 常駐）
* 受入: 連続 24h 稼働 / エラー復旧自動

**M3: 品質MVP（8/29–8/30）**

* T5 完了（dup クラスタ基礎）
* 受入: 近似重複 15–35% をクラスタ化（小さな検証セットで目視確認）

**M4: 監視MVP（8/31）**

* T6 完了
* 受入: `/metrics` を Prometheus/Grafana に取り込み、基本ダッシュボード可視化

以降（拡張フェーズ）

* **E1** 実体リンク（Wikidata QID）スケルトン → `entity_search` 強化
* **E2** イベント抽象（S/P/O → event テーブル）最小実装
* **E3** 評価セット（100クエリ×多言語）/ `recall@10` & `nDCG@10` 週次計測

---

# “人間が視認できるUI” の有無と確認方法

**基本方針**: MCP-First。既定では人間UIは**無効**で、APIのみ公開。
**確認**:

```
# API（常時）
curl -sG "http://127.0.0.1:3011/search" --data-urlencode q="OpenAI" | jq .
curl -sG "http://127.0.0.1:3011/search_sem" --data-urlencode q="OpenAI" | jq .
# ルートは 404（UI無効時の仕様）
curl -i http://127.0.0.1:3011/ | head -n1
```

**開発・検収時だけUIを有効化したい場合**

```
export UI_ENABLED=1
uvicorn web.app:app --host 127.0.0.1 --port 8000 --reload
# ブラウザで http://127.0.0.1:8000/ を開く
```

> 本番は UI 無効推奨。公開は `/search` `/search_sem` `/api/*` のみに限定。

---

## 追記（運用メモ）

* DB/アプリの固定値（DB名 `newshub`、APIポート `3011`）はガードあり。変更多発を防ぎます。
* 取り込みソースは **RSS/NewsAPI/HN** を先に安定化。SNSや GDELT は拡張フェーズで。

---

このまま T0 → T6 を順に回せば、**8/31 までに「取得→検索→運用→監視」の MVP を完成**できます。
まずは **T0** を実行→結果（特に失敗ログ）があればそのまま貼ってください。すぐ次の差分を投げます。
