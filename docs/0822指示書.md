# 0) 前提（CodexCLIに最初に伝える“変更禁止ルール”）

* DBは PostgreSQL16 + pgvector、`chunk_vec.emb` は **vector(768)** 固定。
* 類似度は **cos** 前提（`<=>`／`vector_cosine_ops`）。serverは右辺に **`pgvector.psycopg.Vector`** を必ず渡す。
* 例外時は**必ず新着順フォールバック**に落ちること。
* `ENABLE_SERVER_EMBEDDING` は厳密なブール（"1/true/yes/on" のみ有効）。それ以外は**埋め込み計算をしない**。

---

# 1) 共通ランチャー（セッション最初に貼る）

```
あなたは yangnana7/newspaper リポジトリの実装担当です。
以降は“差分（unified diff）”中心で出力してください。説明は最小限でOK。

共通タスク:
- 作業ブランチ: day3/mcp-cos-and-search
- 変更ファイルが複数ある場合はパッチを分割（0001_..., 0002_...）
- 変更後に必ず: `pytest -q` を実行し、失敗ログがあれば即時修正
- SQLは冪等（IF NOT EXISTS/DO $$）で書くこと
- エラー時のフォールバック（新着順）を壊さないこと
```

---

# 2) タスクA：DBインデックスとtrgm（高速化・冪等）

**指示**

```
目的: ILIKE/新着/重複抑制の速度改善
成果物:
  - 新規: db/indexes_core.sql
  - 追記: db/schema_v2.sql の末尾に“安全な補助インデックス”ブロック
要件:
  - idx_doc_published_at_desc, idx_doc_source,
    idx_doc_urlcanon_published_at_desc (url_canon, published_at DESC)
  - pg_trgm拡張 + title_raw の GIN (gin_trgm_ops)
  - hint(doc_id,key) の複合インデックス
出力: 0001-db-indexes-and-trgm.patch（unified diff）
完了後: `psql "$DATABASE_URL" -f db/indexes_core.sql` を想定
```

---

# 3) タスクB：/search\_sem を実装（cos検索＋フォールバック）

**指示**

```
目的: セマンティック検索APIをFastAPIで追加
変更: mcp_news/server.py
要件:
  - GET /search_sem?limit&offset&space&q
  - q は暫定で JSON float array(768次元)。右辺に pgvector.psycopg.Vector
  - SQL: chunk_vec v JOIN chunk c JOIN doc d
         WHERE v.embedding_space = :space
         ORDER BY v.emb <=> :qvec
  - ENABLE_SERVER_EMBEDDING は厳密ブール判定関数で扱う
  - 例外/異常時は rollback して “新着順 list_latest” を返す
  - 返却スキーマ: {doc_id,title,url,published_at,source,genre_hint}
  - typing_extensions.TypedDict を優先（Py3.11互換）
出力: 0002-server-search-sem-cos.patch
```

---

# 4) タスクC：テスト（疎通＋フォールバック最小）

**指示**

```
目的: /search_sem の基本疎通とフォールバックを担保
追加: tests/test_search_sem.py
検証:
  - q未指定: /search_sem?limit=3 → 200 & list
  - q=ゼロベクトル(768) & limit=2 → 200 & len<=2
  - /search に異常limitを投げても 200 & list（フォールバック確認）
出力: 0003-tests-search-sem.patch
```

---

# 5) タスクD：確認用UIの扱い（削除 or 最小維持）

**指示**

```
目的: UIはあくまで確認用。以下から1つ選ぶ
選択肢1: web/ を残し、/api/latest,/api/search のページング/フィルタ/重複抑制クエリを維持
選択肢2: web/ を削除。READMEに「確認はcurlで」の手順を追記
どちらを選んでもOK。今回のPRではUIに依存しないテストがGreenであること。
出力: 0004-web-keep-or-drop.patch（必要なら）
```

---

# 6) タスクE：運用ドキュメント（再開手順の追記）

**指示**

```
目的: “DBインデックス適用→API疎通→systemd” までの最短ルートを docs に1枚追加
追加: docs/ROADMAP_DAY3.md（または既存の再開マニュアルに追記）
内容:
  - indexes_core.sql の適用手順
  - /search_sem と /search のcurl例
  - systemd のユニット再読み込みとログ確認コマンド
出力: 0005-docs-roadmap-day3.patch
```

---

# 7) タスクF：ニュースソースの追加テンプレ（後続）

**指示**

```
目的: 追加サイトを簡単に生やせる雛形の用意
追加:
  - config/feeds.sample.json に日本語ローカル媒体の例エントリを2-3件
  - scripts/ingest_rss.py が feeds.json の配列をそのまま回すことを確認
  - ingest失敗時はソース名とHTTPステータスを構造化ログ出力
出力: 0006-feeds-template.patch
```

---

# 8) 実行順

1. タスクA → テスト → インデックス適用
2. タスクB → テスト
3. タスクC → テスト（Greenになるまで反復）
4. （任意）タスクD
5. タスクE → 体裁確認
6. （任意）タスクF

---

# 9) 受け入れチェック（人が見るポイント）

* `pytest` が完全Green（新規 `test_search_sem.py` を含む）
* `/search_sem` が **qなしでも200**（新着順フォールバック）
* `/search_sem?q=[...]` が **ORDER BY `<=>`** で実行されている（コード確認）
* 例外時に **500を返さず配列**を返す（空でも可）
* `db/indexes_core.sql` が **冪等**（再実行OK）
* 既存 `schema_v2.sql` の `vector(768)` と整合（壊れていない）

---

# 10) PR本文テンプレ（CodexCLIが書く）

```
目的: cos距離の統一とセマンティック検索APIの導入、運用インデックス整備
変更概要:
- db: indexes_core.sql を新設、schema_v2.sql に冪等な補助索引を追記
- server: /search_sem を追加。pgvector.psycopg.Vector で右辺型を固定、例外時は新着順へフォールバック
- tests: /search_sem の疎通とフォールバックの最小テスト
- docs: ROADMAP_DAY3.md を追加（適用手順とcurl例）
運用影響:
- psql で db/indexes_core.sql を一度適用するだけ
- 既存APIとの互換は維持（/search は従来通り）
確認手順:
- pytest -q
- curl 'http://127.0.0.1:8000/search_sem?limit=3'
- curl --get --data-urlencode 'q=[0,0,...(768)]' 'http://127.0.0.1:8000/search_sem?limit=2'
```

---

# 11) ありがちな失敗と回避文言

* 「cos/L2が混在」→ **“正規化あり×`<=>` 固定。L2禁止。”** と最初に明記。
* 「Vector右辺型不一致」→ **`pgvector.psycopg.Vector` を必ず使う**。
* 「例外で500」→ **`rollback()` 後に新着順で返す**。
* 「環境変数の曖昧パース」→ **厳密ブール関数**を実装して使う。
* 「非冪等SQL」→ **IF NOT EXISTS/DO \$\$** で包む。
