# サーバーリソース点検手順書（Ubuntu 24.04）

## 目的

本サーバー（Intel i3-6100T / 8GB RAM）で **MCPニュース集約サーバー** を安定運用できるかを確認するため、
CPU・メモリ・プロセス状況・サービス稼働状態を調査する。

---

## 1. CPU/メモリの現状確認

```bash
# CPU/メモリ全体の概要
lscpu
free -h
```

チェックポイント:

* CPU コア数とスレッド数 (i3-6100T → 2C/4T が見えるはず)
* メモリ使用量と空き容量（8GB中どれくらい空いているか）

---

## 2. 稼働中プロセスと負荷状況

```bash
# リアルタイム監視
htop
```

（※インストールされていない場合）

```bash
sudo apt install -y htop
htop
```

見るポイント:

* `postgres`, `python`, `uvicorn` プロセスが占める CPU% と MEM%
* 他の「でかいアプリ」が常駐していないか（Java, Node, Docker等）

---

## 3. PostgreSQL のメモリ使用確認

```bash
# PostgreSQL の主要設定を確認
sudo -u postgres psql -c "SHOW shared_buffers;"
sudo -u postgres psql -c "SHOW work_mem;"
sudo -u postgres psql -c "SHOW effective_cache_size;"

# プロセスごとのメモリ消費
ps -o pid,ppid,cmd,%mem,%cpu --sort=-%mem | grep postgres
```

チェックポイント:

* `shared_buffers` が 1GB 程度に収まっているか（8GB機では妥当）
* `work_mem` を大きくしすぎていないか（デフォルトのままでよい）

---

## 4. サービス稼働状況

```bash
# systemd で登録したタイマー・サービスの状態
systemctl status ingest.timer
systemctl status embed.timer
systemctl status mcp-news.service
systemctl status postgresql
```

チェックポイント:

* `Active: active (running)` であるか
* エラーが繰り返されていないか (`journalctl -u <サービス名>`)

---

## 5. リソース監視（常駐設定）

```bash
# 5秒ごとの CPU/メモリ/IO 使用率を記録
dstat -tcmg --top-mem --top-cpu 5
```

（※未導入なら）

```bash
sudo apt install -y dstat
```

---

## 6. 即時診断のまとめ指標

* **CPU使用率**: 平常時 idle が 70%以上 → OK
* **メモリ残量**: `free -h` で使用中が 6GB以下 → OK
* **postgres プロセス**: 各プロセスのメモリが数百MB程度 → OK
* **サービス状態**: `systemctl status` がすべて active → OK

---

## 7. 注意事項

* サーバー側で埋め込み生成を有効にしないこと

  ```bash
  grep ENABLE_SERVER_EMBEDDING /etc/default/mcp-news
  # → 0 であることを確認
  ```
* 他の重量級アプリ（Java, Docker, Node, TensorFlow等）が常駐していないか必ず確認。
* 常時ログ監視用コマンド

  ```bash
  journalctl -u mcp-news.service -f
  ```

---

✦ この手順に従って点検すれば、
**「現在のサーバーでMCPニュースサーバーが安定稼働できるか」** の判断材料が揃います。
点検結果は以下のフォーマットに従って報告してください。

以下が「実行 → 判定 → レポート返却」
Yes/No で答えて、必要ならコメント（理由/数値）を書くフォーマットです。

---

# サーバー点検レポート用チェックリスト（Ubuntu 24.04 / i3-6100T / 8GB）

### 1. CPU / メモリ概要

* [ ] CPUコア数 = 2, スレッド数 = 4
  結果: (Yes/No) — 実際の出力: \_\_\_\_\_\_
* [ ] 空きメモリが 2GB 以上
  結果: (Yes/No) — 実際の出力: \_\_\_\_\_\_

---

### 2. プロセスと負荷

* [ ] `postgres`, `python`, `uvicorn` が常駐
  結果: (Yes/No) — 補足: \_\_\_\_\_\_
* [ ] idle CPU が 70%以上
  結果: (Yes/No) — 実測 idle%: \_\_\_\_\_\_
* [ ] 他に重量アプリ（Docker, Java, Node, TensorFlow 等）が常駐していない
  結果: (Yes/No) — 発見された場合: \_\_\_\_\_\_

---

### 3. PostgreSQL 設定

* [ ] shared\_buffers ≈ 1GB
  結果: (Yes/No) — 実際の値: \_\_\_\_\_\_
* [ ] work\_mem が数MB程度（大きすぎない）
  結果: (Yes/No) — 実際の値: \_\_\_\_\_\_
* [ ] postgres プロセスのメモリ消費が数百MB以内
  結果: (Yes/No) — 最大使用量: \_\_\_\_\_\_

---

### 4. サービス稼働状態

* [ ] postgresql が active (running)
  結果: (Yes/No)
* [ ] ingest.timer が active (waiting)
  結果: (Yes/No)
* [ ] embed.timer が active (waiting)
  結果: (Yes/No)
* [ ] mcp-news.service が active (running)
  結果: (Yes/No)

---

### 5. リソース監視（リアルタイム）

* [ ] CPU使用率が高止まりしていない（常時80%未満）
  結果: (Yes/No) — 実測: \_\_\_\_\_\_
* [ ] メモリ使用率が 80% 未満
  結果: (Yes/No) — 実測: \_\_\_\_\_\_

---

### 6. 埋め込み処理の確認

* [ ] `ENABLE_SERVER_EMBEDDING=0` が設定されている
  結果: (Yes/No) — 実際の値: \_\_\_\_\_\_

---

### 7. ログ確認

* [ ] mcp-news.service にエラー繰り返しがない
  結果: (Yes/No) — 補足: \_\_\_\_\_\_
* [ ] ingest.service に取り込み失敗の連続がない
  結果: (Yes/No) — 補足: \_\_\_\_\_\_

---

## 総合判定

* [ ] 全て Yes → **安定稼働可能**
* [ ] 一部 No → **改善必要（内容をコメント欄に記録）**

---
