前提の固定ルール（DB は newshub、待受は 127.0.0.1:3011、距離関数は cosine）は厳守でお願いします。/docs/マニュアル.md

---

# 作業指示書（CodexCLI向け / 2025-08-24）

## 0) 今日の目的（要約）

* ① `chunk_vec` へ **HNSW（cosine）** インデックスを構築
* ② `semantic_search` の **ランク融合パラメータ** を設定ファイル化
* ③ 取り込み/埋め込み件数の **Prometheusメトリクス** をエクスポート
* ④ `/docs` へ作業ログと運用メモを追記（本プロジェクトの規約）

※ ①〜③は「次回タスクの推奨順」1〜3番に対応します。
※ pgvector 検索は HNSW＋再ランクが設計方針です。

---

## 1) HNSW（cosine）インデックスの作成

### 1-1. 変更（DDL）

作成ファイル: `db/index_hnsw_chunk_vec.sql`

```sql
-- HNSW index for cosine on embedding_space = 'bge-m3'
CREATE INDEX IF NOT EXISTS hnsw_chunk_vec_bgem3_cos
ON chunk_vec
USING hnsw (emb vector_cosine_ops)
WHERE embedding_space = 'bge-m3';
```

**注**: 本プロジェクトの距離関数は cosine 固定です（L2は禁止）。

### 1-2. 実行

```bash
psql "$DATABASE_URL" -f db/index_hnsw_chunk_vec.sql
```

### 1-3. 受入テスト（最低）

```sql
-- インデックス有無
SELECT indexname, indexdef
FROM pg_indexes
WHERE tablename='chunk_vec'
  AND indexname='hnsw_chunk_vec_bgem3_cos';
```

期待: 1行返り、`USING hnsw (... vector_cosine_ops)` を含む。

---

## 2) ランク融合パラメータの外部化

### 2-1. 設定ファイル

作成ファイル: `config/ranking.yaml`

```yaml
score_weights:
  cosine: 0.7
  recency: 0.2
  source_trust: 0.1
recency_half_life_hours: 48
source_trust:
  default: 0.0
  # 例: 供給元ごとの重み
  nhk.or.jp: 0.2
  apnews.com: 0.1
```

（設計上の既定値は 0.7/0.2/0.1 を採用）

### 2-2. 実装変更

編集: `mcp_news/search.py`（仮）

* `load_ranking_config()` を追加（`config/ranking.yaml` をロード）
* `score = α·cos + β·recency + γ·source_trust` で再ランク
* 既定フォールバックはファイル未在時に 0.7/0.2/0.1

### 2-3. 単体テスト

作成: `tests/test_ranking_config.py`

```python
def test_ranking_yaml_loads_and_weights_sum_to_1():
    from mcp_news.search import load_ranking_config
    c = load_ranking_config()
    s = c["score_weights"]
    assert abs(s["cosine"] + s["recency"] + s["source_trust"] - 1.0) < 1e-6
```

目的: 再ランクの係数運用を“人間が決め打つ”ための外部化（設計の方針）。

---

## 3) Prometheus メトリクスエクスポート

### 3-1. 実装

編集: `mcp_news/server.py`

* `prometheus_client` を使用し `/metrics` を公開（FastAPI へルーティング）
* **Counter**: `items_ingested_total`, `embeddings_built_total`
* **Histogram**: `ingest_duration_seconds`, `embed_duration_seconds`

監視で Prometheus Exporter を用いるのが設計方針です。

### 3-2. 受入テスト（動作）

```bash
curl -s http://127.0.0.1:3011/metrics | head
```

期待: `# HELP` 付きメトリクスが返る（※サービスは 127.0.0.1:3011 固定）。

---

## 4) エンドポイント/環境の固定ガード再確認（改変禁止）

* DB名: **newshub**、待受: **127.0.0.1:3011** は固定（起動時ガード必須）。&#x20;
* `.env` 例は `/etc/default/mcp-news` に定義済み（`EMBEDDING_SPACE=bge-m3` など）。

---

## 5) ドキュメントとログ

* `/docs/daily/2025-08-24.md` を新規作成

  * 変更点の要約、DDL/設定ファイル一覧、テスト結果（コピー可）
* `/docs/ops/metrics.md` を追補（`/metrics` 利用法、Grafana取り込みメモ）
  （**/docs へ記録**は運用規約）

---

## 6) 参考（設計・運用の背景）

* HNSW 近傍＋再ランクは本設計の中核（ベクトル検索＋新鮮度＋信頼度）。
* “MCP-First”：公開はAPI中心、UIは検証用のみ。
* スプリント指針：rank 融合と監視は短期フェーズの到達点。

---

## 7) Git 運用（提案）

### 7-1. 典型コミット

```
feat(db): add HNSW (cosine) index on chunk_vec (bge-m3)
feat(search): load ranking weights from config/ranking.yaml
feat(metrics): expose /metrics with ingest/embed counters
docs: add daily log 2025-08-24 and ops/metrics notes
```

### 7-2. PR チェック項目（人間レビュー向け・短文）

* DDLは cosine（`vector_cosine_ops`）か
* ランク重みの合計=1.0 か
* `/metrics` が 127.0.0.1:3011 で到達可能か（UIは不要）

---

**進捗％の計算式（提案）**
`Progress = Σ(各項目の達成フラグ × 重み)`

---

## ロールバック手順（簡易）

1. インデックス削除:

   ```sql
   DROP INDEX IF EXISTS hnsw_chunk_vec_bgem3_cos;
   ```
2. 設定戻し: `git checkout -- config/ranking.yaml`
3. `/metrics` 停止: 該当ルートをコメントアウトして再起動
4. 記録: `/docs/daily/2025-08-24.md` にロールバック理由を追記

---

## 注意（必読）

* サービス待受/DB名/距離関数は**固定**（変更多発につき再掲）。
* `.env` は `/etc/default/mcp-news` に集約（`EMBEDDING_SPACE=bge-m3`）。
* 本日のタスクは「HNSW → ランク融合設定 → メトリクス」の順で実施（推奨順 1〜3）。

---

これで作業を進められます。必要ならこのまま `/docs/daily/2025-08-24.md` に貼り付けて運用記録にしてください。