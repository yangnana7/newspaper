# 作業実施ログ・報告書 (2025-08-24)

**対象プロジェクト**: MCPニュース集約サーバー
**作業環境**: Ubuntu 24.04 / Intel i3-6100T / 8GB RAM
**作業者**: ＜記入＞
**開始時刻**: ＜JST 時刻＞ / **終了時刻**: ＜JST 時刻＞
**対象コミット**: `git rev-parse HEAD` = `<ハッシュ>`（作業前） → `<ハッシュ>`（作業後）

---

## 1. 今日の目的（受入条件）

* systemd サービスを **web.app\:app** で常時起動（`active (running)` 維持）
* `GET /search` と `GET /search_sem` が **200 OK**（空でも200）
* `/etc/default/mcp-news` に **ENABLE\_SERVER\_EMBEDDING=0** を確認
* 主要ログ・証跡を本書に添付

---

## 2. 実施作業サマリー

| タスク             | 状態    | 結果                          |
| --------------- | ----- | --------------------------- |
| systemd サービス修正  | □ / ✅ | active(running) / 失敗時は原因    |
| /search API 検証  | □ / ✅ | 200 OK / レスポンス例添付           |
| /search\_sem 検証 | □ / ✅ | 200 OK / レスポンス例添付           |
| EMBEDDING 設定確認  | □ / ✅ | ENABLE\_SERVER\_EMBEDDING=0 |
| スモークテスト         | □ / ✅ | 全OK / NG項目は番号化              |
| Docs 更新         | □ / ✅ | 差分あり / なし                   |

※ □→未、✅→完了（本文の証跡で裏付け）

---

## 3. 詳細ログ（証跡）

### 3.1 systemd ユニット統一（web.app\:app）

**対象**: `/etc/systemd/system/mcp-news.service`

```ini
# 期待される ExecStart（証跡として貼付）
[Service]
WorkingDirectory=/opt/mcp-news
EnvironmentFile=/etc/default/mcp-news
ExecStart=/opt/mcp-news/.venv/bin/uvicorn web.app:app --host ${APP_BIND_HOST} --port ${APP_BIND_PORT}
Restart=on-failure
```

**適用コマンドと出力**

```bash
sudo systemctl daemon-reload
sudo systemctl restart mcp-news.service
sudo systemctl status mcp-news.service --no-pager
# ↑ status 全文をここに貼付（active (running) の行を含める）
journalctl -u mcp-news.service -n 100 --no-pager
# ↑ ERROR/WARN が無いことを確認、全文貼付
```

> 判定: **active (running)** / **failed**（失敗なら Exit code・Trace をここに明記）

---

### 3.2 環境ファイル最終化

**対象**: `/etc/default/mcp-news`（抜粋を貼付）

```bash
grep -E '^(DATABASE_URL|APP_BIND_HOST|APP_BIND_PORT|EMBEDDING_SPACE|ENABLE_SERVER_EMBEDDING)=' /etc/default/mcp-news
# 期待値:
# DATABASE_URL=postgresql://127.0.0.1:5432/newshub
# APP_BIND_HOST=127.0.0.1
# APP_BIND_PORT=3011
# EMBEDDING_SPACE=bge-m3
# ENABLE_SERVER_EMBEDDING=0
```

> 判定: **ENABLE\_SERVER\_EMBEDDING=0** を確認 / 未設定（理由と対処を下に記述）

---

### 3.3 公開API検証

**/api/latest**

```bash
curl -sS "http://127.0.0.1:3011/api/latest?limit=2" | jq
# 期待: HTTP 200 / JSON配列 / 件数<=2
```

**/search（語彙検索）**

```bash
curl -sS -w "\n%{http_code}\n" "http://127.0.0.1:3011/search?q=hello&limit=5"
# 期待: 最終行 200
# 先頭数行のJSONを貼付
```

**/search\_sem（意味検索）**

最低限のフォールバック確認（q省略）:

```bash
curl -sS -w "\n%{http_code}\n" "http://127.0.0.1:3011/search_sem?limit=5"
# 期待: 200 / 最新順の配列
```

可能ならベクトル入力（q=JSON配列）でも確認:

```bash
# 例: ダミーベクトル（次元は環境に合わせる。NGならスキップ可）
curl -sS -G "http://127.0.0.1:3011/search_sem" \
  --data-urlencode 'limit=5' \
  --data-urlencode 'q=[0.01,0.02,0.03]' -w "\n%{http_code}\n"
# 期待: 200
```

> 判定: **/search=200**、**/search\_sem=200**（本文に最終HTTPコードを明記）

---

### 3.4 スモーク（まとめ）

```bash
set -ex
curl -sf "http://127.0.0.1:3011/api/latest?limit=2" >/dev/null
curl -sf "http://127.0.0.1:3011/search?q=test&limit=1" >/dev/null
curl -sf "http://127.0.0.1:3011/search_sem?limit=1" >/dev/null
echo "SMOKE_OK"
```

> 判定: **SMOKE\_OK** / 失敗（コマンドと戻り値を貼付）

---

### 3.5 リソース点検（抜粋）

```bash
uptime
free -h
df -h /
ps -eo pid,pmem,pcpu,comm --sort=-pmem | head -n 10
```

> 判定: CPU負荷・メモリに異常無し / 注意点あり（数値を本文に）

---

## 4. 差分とドキュメント更新

**更新ファイル**（抜粋と要点だけ列挙）

* `docs/server_fix_2025_08.md`

  * `ExecStart` を **web.app\:app** に統一
  * 反映手順（daemon-reload / restart / status）を最新化

* `docs/next_tasks_2025_08.md`

  * 該当項目を **完了** に切替（完了根拠＝本書の証跡）

**差分ログ**

```bash
git add -A
git commit -m "docs: 2025-08-24 systemd/web.app統一とAPI受入証跡の追加"
git show --stat
```

---

## 5. 結果判定（本日の最終ステータス）

* systemd：□未 / ✅完了（active (running) 確認）
* /search：□未 / ✅200 OK
* /search\_sem：□未 / ✅200 OK
* EMBEDDING 設定（=0）：□未 / ✅確認済
* 重大エラー：なし / あり（→「6. 付記」に記載）

**総合評価**: ＜合格 / 部分合格 / 不合格＞
**根拠**: 上記証跡の該当行番号と要約を箇条書き

---

## 6. 付記（問題・TODO）

* 例）`/search_sem` のベクトル入力はローカル生成未導入のため q 省略でのみ検証 … など
* 例）RSS タイマーは次回検収（ユニット有効化・journal の確認）

---

## 7. 引き継ぎ

* 次回は **ingest タイマー（systemd timer）** の導入確認とログ保全
* 例）`newshub-ingest@.timer` の `enable --now`、`journalctl -u` の定期監査

---

### 付録A：`systemctl status` 出力（全文）

```
＜ここに status 出力全文＞
```

### 付録B：`journalctl` 抜粋（直近100行）

```
＜ここに journalctl 出力全文＞
```

### 付録C：API レスポンス例（先頭のみ）

```
/api/latest → ＜JSON 抜粋＞
/search → ＜JSON 抜粋＞
/search_sem → ＜JSON 抜粋＞
```
