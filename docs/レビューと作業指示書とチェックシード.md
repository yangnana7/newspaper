以下に、現行 master ブランチのレビューと、次に進めるための作業指示書および進捗可視化（マイルストーン）をまとめました。

---

## 1. master ブランチのレビュー

### 実装状況の要約

* **外部ID連携スクリプト**: `scripts/link_entities_wikidata.py` では、Wikidata API を呼び出して `entity.ext_id` が `NULL` のレコードに QID を設定し、更新件数を返す関数 `link_missing()` が実装されました。
* **エンティティ登録の重複回避**: `scripts/ingest_entities.py` は `attrs->>'name'` で既存レコードを検索し、なければ挿入して `mention` に関連づける処理に改善されました。
* **イベント抽出拡張**: `scripts/event_extract.py` では、日付に加えて `extract_entities()` の結果をイベントの `participants` に追加し、テキストに「東京」が含まれる場合は簡易的に `loc_geohash=xn76` を付与するようになりました。
* **イベント登録の参加者登録**: `scripts/ingest_events.py` では、抽出したイベントごとに `event` 表へ挿入後、関連ドキュメントを `evidence` 表で紐付け、参加者名から `entity` を検索・挿入し `event_participant` に登録しています。
* **`event_timeline` API 拡張**: `mcp_news/server.py` の `event_timeline` ツールは、フィルタ条件に ext\_id/type\_id/期間を指定でき、返却データに参加者（ext\_id と name）と関連ドキュメントIDを含めるようになりました。
* **ランキング言語対応**: `search/ranker.py` は `load_language_trust()` を追加し、言語別重み付けをスコアに組み込みました。`config/ranking.yaml` には `language_trust` セクションがあり、日本語0.9、英語0.8、中国語0.5などが定義されています。
* **新スキーママイグレーション**: `db/migrations/2025-08-27_entity_name_unique.sql`（レビュー対象外）で `attrs->>'name'` にユニーク制約が追加され、同名エンティティの重複を防ぐ設計となりました。
* **CI・テスト**: DB 接続が不要な環境では `SKIP_DB_TESTS=1` により DB依存テストがスキップされ、Wikidata連携は monkeypatch によりモック化されています。

### 評価と改善ポイント

* **全体的に大幅な前進**: エンティティ抽出→外部ID付与→イベント抽出→タイムライン表示の一連の流れが基礎的に機能しました。言語重みも導入され、検索品質の調整がしやすくなっています。
* **重複対策の実装**: `ingest_entities.py` で既存レコードを検索して再利用する処理が追加されましたが、ユニーク制約を新設した関係で `ON CONFLICT` を用いた明示的な upsert に置き換えるとより安全です。
* **イベントの詳細性**: 現在の `event_extract` は日時と参加者・簡易位置のみを取り扱っており、タイプ分類や場所推定・役割判定などは未実装です。今後の機能拡張で精度向上が求められます。
* **外部IDの信頼度設計**: Wikidata から返される候補の選択基準や rate limit 対策が未定です。類似名の衝突や多義語の扱いについても検討が必要です。

---

## 2. 次の作業指示書（2025‑08‑28〜）

以下の作業は現状の到達点を踏まえた次のマイルストーンです。DB 名 `newshub`、ポート `127.0.0.1:3011`、距離関数 `cosine`、UI は既定で無効という固定ルールは引き続き守ってください。

### A) 外部IDリンクの精度向上と運用自動化

1. **Wikidata連携の信頼度評価**

   * `scripts/link_entities_wikidata.py` に、API応答の `searchinfo['search']` から `description` や `match-type` などを確認し、閾値に満たない場合は `ext_id` を設定しないロジックを追加する。
   * 設定ファイル（例：`config/linking.yaml`）でキーワードブラックリストや優先ドメインを指定できるようにする。
2. **rate limit 対策**

   * 多数のエンティティを処理する際、1秒あたりのリクエスト数を制御し、エラー時のリトライ回数を設定する。
   * 進捗ログをファイルに出力し、途中で停止しても再開可能なようにする。
3. **一意制約に沿った upsert**

   * `scripts/ingest_entities.py` の挿入処理を `ON CONFLICT (attrs->>'name') DO UPDATE SET ...` に改修し、同じ名前で複数行が生成されないようにする。
   * テスト `tests/test_entity_upsert.py`（新規）を作成し、同じ名称を複数回 ingest しても entity が1件に保たれることを確認する。

### B) イベント抽出の高度化

1. **イベントタイプ分類**

   * `scripts/event_extract.py` に `type_id` 判定ロジックを追加し、ニュース本文から `会談`・`記者会見`・`災害` 等のキーワードを検出して `type_id` を設定する。
   * `docs/design/entity_event_plan.md` にある分類案を基準に、未定義のタイプは `9999` とする。
2. **場所抽出の改善**

   * 都道府県や主要都市の辞書を用意し、地名があれば緯度経度または geohash へのマッピングを行う。
   * 可能であれば `geopy` などのライブラリを利用し、曖昧な地名はスキップする。
3. **参加者の役割推定**

   * `extract_events()` の返り値に `participants` の各要素を `{"name": name, "role": "speaker"}` のように拡張する準備を行う。ロールは未確定で `None` でも可。
4. **テスト強化**

   * `tests/test_event_classification.py` を追加し、所定のニュース文から適切な `type_id`・`loc_geohash`・`participants` が抽出されることを検証する。

### C) APIとUIの拡充

1. **event\_timeline フィルタ拡充**

   * `event_timeline` の引数 `filter` に `participant_ext_id` や `loc_geohash` を追加し、該当イベントのみを抽出できるように SQL を拡張する。
2. **エンティティ検索の改良**

   * `entity_search` ツールを `name` ベースでも検索できるよう拡張し、外部IDがない場合でも関連記事を取得できるようにする（ただし曖昧検索のままでは大量にヒットするため制限が必要）。
3. **簡易 UI の拡張（任意）**

   * `/api/events` エンドポイントを追加し、日付順にイベントを返す。
   * UI ページにイベントタイムラインや参加者リストを表示するテンプレートを用意する。

### D) 言語判定の導入とランキング調整

1. **言語検出スクリプト**

   * `scripts/set_language.py` を作成し、取り込み済みの `doc` レコードに対して `langdetect` や `fasttext` を用いて `d.lang` を設定する。
   * 未検出の場合は `NULL` とし、`language_trust` のデフォルト値を適用する。
2. **ランキングの多言語対応強化**

   * `language_trust` に新しい言語コードを追加し、特に韓国語やロシア語など他言語のニュースを扱う場合の重みを設計する。
   * 新テスト `tests/test_language_detection.py` を作成し、検出精度と重み付けの反映を確認する。

### E) ドキュメントと運用手順の更新

1. **設計ドキュメント更新**

   * `docs/design/entity_event_plan.md` に外部IDリンクの信頼度判定、イベントタイプ分類の詳細、場所抽出手法を追記する。
   * `docs/ops/metrics.md` に新たなメトリクス（例: `entities_linked_total`, `events_with_participants_total`）を追加し、運用監視の指針を更新する。
2. **日次ログ更新**

   * `docs/daily/2025-08-28.md` を新規作成し、本指示書の内容、作業状況、CI結果を記録する。

---

## 3. 進捗状況チェックシート（2025‑08‑28 用）

| No | 項目                     | コマンド例・エビデンス                                                                                 | 期待値         |  重み | 状態   |
| -: | :--------------------- | :------------------------------------------------------------------------------------------ | :---------- | :-: | :--- |
|  1 | Wikidata 連携の信頼度実装      | `grep -q 'confidence' scripts/link_entities_wikidata.py`                                    | 信頼度に関する処理あり |  8  | \[ ] |
|  2 | Entity upsert 改修       | `grep -q 'ON CONFLICT' scripts/ingest_entities.py`                                          | upsert構文あり  |  5  | \[ ] |
|  3 | 外部IDリンクテスト             | `pytest -q tests/test_entity_upsert.py`                                                     | 0 failed    |  8  | \[ ] |
|  4 | イベントタイプ判定              | `grep -q 'type_id' scripts/event_extract.py`                                                | 詳細判定ロジックあり  |  7  | \[ ] |
|  5 | 場所抽出・参加者役割             | `grep -q 'loc_geohash' scripts/event_extract.py && grep -q 'role' scripts/event_extract.py` | 2箇所ヒット      |  7  | \[ ] |
|  6 | イベントテスト拡張              | `pytest -q tests/test_event_classification.py`                                              | 0 failed    |  8  | \[ ] |
|  7 | event\_timeline フィルタ拡張 | `grep -q 'participant_ext_id' mcp_news/server.py`                                           | クエリ拡張あり     |  5  | \[ ] |
|  8 | 言語検出スクリプト作成            | `test -f scripts/set_language.py && echo OK`                                                | `OK`        |  5  | \[ ] |
|  9 | 言語検出テスト                | `pytest -q tests/test_language_detection.py`                                                | 0 failed    |  6  | \[ ] |
| 10 | 新メトリクス定義               | `grep -q 'entities_linked_total' mcp_news/metrics.py`                                       | ヒット         |  5  | \[ ] |
| 11 | CI更新（言語検出依存）           | `grep -q 'langdetect' requirements-dev.txt`                                                 | ヒット         |  5  | \[ ] |
| 12 | ドキュメント更新               | `git ls-files docs/daily/2025-08-28.md`                                                     | ファイル存在      |  5  | \[ ] |
| 13 | ポリシー維持                 | `pytest -q tests/test_ci_env.py`                                                            | 0 failed    |  4  | \[ ] |

進捗率は達成済み項目の重み合計で計算してください（合計100％）。
