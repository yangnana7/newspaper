以下に、最新の master ブランチに対するレビューと、今後進めるための作業指示書・進捗チェックシートをまとめました。

---

## 1. master ブランチのレビュー

### 主な変更点・実装状況

* **共通メトリクスモジュール**
  `mcp_news/metrics.py` に非同期専用デコレータを実装し、`time.perf_counter()` で経過時間を測って `Histogram.observe()` に記録する方式に変更されました。これにより `prometheus_client` のプライベートAPI `_timer` 依存が解消されています。
* **メトリクス厳密検証テスト**
  `tests/test_metrics_counters.py` では、ラベルの有無どちらにも対応した正規表現でメトリクス値を取得し、`record_ingest_item()` と `record_embedding_built()` による +1 増分、および非同期デコレータ経由のヒストグラムカウント増分（+≥1）を検証します。`prometheus_client` がインストールされていない環境では `skip` にする処理もあります。
* **DB 依存テストのスキップ制御**
  `tests/test_search_sem.py` では、環境変数 `SKIP_DB_TESTS=1` で DB を利用するテストをスキップするようになりました。CI では DB サービスを起動しない方針のため、`.github/workflows/ci.yml` で `SKIP_DB_TESTS` を `1` に設定しています。
* **テスト環境固定**
  `tests/conftest.py` が追加され、`DATABASE_URL=postgresql://127.0.0.1/newshub` 等の固定値をデフォルト設定として注入します。CI 環境でも `.github/workflows/ci.yml` で同じ値が注入されており、固定ポリシーに準拠しています。
* **CI 設定**
  GitHub Actions で Python 3.11＋開発用依存 (`requirements-dev.txt`) をインストールし、`pytest` を実行する構成になりました。ブランチ対象に `Feature/0824 workbanch`・main・master が含まれます。
* **その他ドキュメント／スケルトン追加**
  エンティティリンクやイベント抽出のスケルトン (`scripts/entity_link.py`、`scripts/event_extract.py`) が追加され、概要設計は `docs/design/entity_event_plan.md` にまとめられています。

### 良い点

* 非同期メトリクスの実装とテストが整い、Prometheus との整合性が向上しました。
* CI 環境での DB 依存を適切にスキップできる仕組みが整いました。
* 作業ログや作業報告書が分割され、各変更の意図が明確です。

### 改善提案

1. **DB 接続関数のデフォルト DSN**
   `mcp_news/db.py` では `postgresql://localhost/newshub` がデフォルトになっています。一貫性のため、`127.0.0.1` に統一するか、環境変数に依存しない場面が無いように注意してください。現状は `conftest.py` や CI 設定で上書きしているため動作に影響はありませんが、誤設定防止の観点で検討すると良いでしょう。
2. **環境固定ガードの導入**
   `mcp_news/server.py` や `web/app.py` ではポートやホストの固定をチェックしていません。`require_fixed_env()` のような関数で、ホストが `127.0.0.1`、DB 名が `newshub` であるかを起動時に検証しておくと、意図せぬ変更を防げます。
3. **UI と API の依存分離**
   現状の `/api/search` エンドポイントは直接 `psycopg.connect()` を行っており、DB が無い環境では例外が投げられます。将来的には DB が無い場合も動作するモック層やリトライ層を設けると、テスト容易性が向上します。

全体として、既にCIは緑となっており、master へマージされた変更はポリシーに沿った内容です。今後はエンティティリンクやイベント抽出など、本来の機能拡張を進める段階に入ります。

---

## 2. 次のステップ作業指示書（2025‑08‑26)

**目的:** skeleton だったエンティティリンクとイベント抽出を具体化し、ランキング機構の信頼度調整を多言語対応に拡張する。
**固定ポリシー:** DB 名 `newshub`・待ち受け `127.0.0.1:3011`・ベクトル距離は cosine・UI は既定で無効。

### 1) エンティティリンクの初期実装

1. **NER モジュールの導入**

   * 軽量な日本語NERツールを選定し (`spaCy ja_core_news_sm` など) `requirements-dev.txt` に追加。
   * `scripts/entity_link.py` の `extract_entities(text: str) -> List[str]` を実装し、記事本文から人名・組織名・地名を抽出して surface form のリストを返す。
   * 例として、漢字3文字以上またはカタカナ連続語を簡易抽出する fallback 実装も追加しておく。
2. **DB 登録スクリプト**

   * 新規ファイル `scripts/ingest_entities.py` を作成し、`chunk` 表から本文を読み、`extract_entities()` で抽出したsurface formを `entity`・`mention` テーブルに登録する処理を記述（存在チェックと `pgvector` 拡張の利用は不要）。
3. **テスト**

   * `tests/test_entity_extraction.py` を追加し、サンプルテキストに対して所定の単語が抽出されることを検証。
   * 環境にNERモデルが無い場合は `pytest.skip` とする。

### 2) イベント抽出の初期実装

1. **イベント抽出ロジック**

   * `scripts/event_extract.py` の `extract_events(text: str) -> List[Dict[str,Any]]` を実装し、日付表現（YYYY/MM/DDや「８月２４日」等）と地名を検出し、`{"type_id": 9999, "t_start": date_str, "t_end": date_str, "participants": []}` の形式で返す。
   * `type_id=9999` は暫定的な“その他イベント”とし、日付のみ抽出できた場合でも記録する。
2. **DB 登録スクリプト**

   * 新規ファイル `scripts/ingest_events.py` を作成し、`event`・`event_participant` テーブルに登録するSQLを発行する。ロールバック処理と idempotent な upsert 仕様を検討。
3. **テスト**

   * `tests/test_event_extraction.py` を追加し、サンプルテキストからイベントリストが生成されることを確認。

### 3) ランキング設定の多言語信頼度拡張

1. **YAML 設定拡張**

   * `config/ranking.yaml` に `language_trust` セクションを追加し、例として `{ ja: 0.9, en: 0.8, zh: 0.5 }` のように言語別の信頼度を定義する。
2. **実装変更**

   * `search/ranker.py` または `mcp_news/search.py` に、候補文書の言語判定を行い（既に `doc.language` カラムがある場合はそれを利用）、`score = cosine*α + recency*β + source_trust*γ + language_trust*δ` とする重み計算に拡張。`δ` は新しい重みパラメータで、合計が1.0になるように正規化する。
3. **テスト**

   * `tests/test_language_trust.py` を追加し、日本語と英語の記事に対して設定ファイルの `language_trust` が読み込まれること、重み合計が1.0になることを確認する。

### 4) パイプライン統合とドキュメント更新

1. **取り込みスクリプトの修正**

   * `ingest_rss.py` や `ingest_hn.py` など記事をDBに保存する処理の最後に、`extract_entities()` と `extract_events()` を呼び出して結果をテーブルに登録する（フェイルセーフで実装、失敗しても全体の取り込みを止めない）。
2. **CI 更新**

   * NERライブラリや追加依存（例: `ja_core_news_sm`, `regex`）を `requirements-dev.txt` に追記し、CI でインストールする。
   * NERモデルのダウンロードが必要な場合は `python -m spacy download ja_core_news_sm` を事前ステップに追加。
3. **ドキュメント整備**

   * `docs/design/entity_event_plan.md` に初期実装の詳細・制約・今後の改善方針を追記。
   * `docs/ops/metrics.md` に新しいメトリクスや `language_trust` 設定の説明を追加。
   * `docs/daily/2025-08-26.md` を新規作成し、本作業指示書と進捗を記録。

---

## 3. 作業達成確認チェックシート（2025‑08‑26 用）

| No | 項目                      | コマンド例・エビデンス                                                                                                 | 期待値          | 重み(%) | 状態   |
| -- | ----------------------- | ----------------------------------------------------------------------------------------------------------- | ------------ | ----: | ---- |
| 1  | NER依存導入                 | `pip install spacy ja_core_news_sm`                                                                         | 正常終了         |     8 | \[ ] |
| 2  | `extract_entities` 実装   | `grep -q 'def extract_entities' scripts/entity_link.py && ! grep -q 'return \\[]' scripts/entity_link.py`   | 空リスト返しではない   |    10 | \[ ] |
| 3  | `ingest_entities.py` 作成 | `test -f scripts/ingest_entities.py && echo OK`                                                             | `OK`         |     5 | \[ ] |
| 4  | entityテスト               | `pytest -q tests/test_entity_extraction.py`                                                                 | 0 failed     |    10 | \[ ] |
| 5  | `extract_events` 実装     | `grep -q 'def extract_events' scripts/event_extract.py && ! grep -q 'return \\[]' scripts/event_extract.py` | 空リスト返しではない   |    10 | \[ ] |
| 6  | `ingest_events.py` 作成   | `test -f scripts/ingest_events.py && echo OK`                                                               | `OK`         |     5 | \[ ] |
| 7  | eventテスト                | `pytest -q tests/test_event_extraction.py`                                                                  | 0 failed     |    10 | \[ ] |
| 8  | `language_trust` 設定追加   | `grep -q 'language_trust' config/ranking.yaml`                                                              | 行が存在         |     5 | \[ ] |
| 9  | ランキング拡張実装               | `pytest -q tests/test_language_trust.py`                                                                    | 0 failed     |    12 | \[ ] |
| 10 | 取り込みへの統合                | 手動確認: `ingest_rss.py`/`ingest_hn.py` に entity/event 呼び出しがあるか                                                | コードが存在       |    10 | \[ ] |
| 11 | CI更新                    | `grep -q 'spacy' .github/workflows/ci.yml`                                                                  | インストールステップあり |     5 | \[ ] |
| 12 | ドキュメント更新                | `git ls-files docs/daily/2025-08-26.md`                                                                     | ファイル存在       |    10 | \[ ] |
| 13 | 環境固定維持                  | `pytest -q tests/test_ci_env.py`                                                                            | 0 failed     |    10 | \[ ] |

進捗率はチェック済みの重み合計で算出してください。

---

上記の指示書とチェックシートに従って作業を進めれば、今回の skeleton から一歩進んだ機能追加が行えます。必要に応じて日次ログ (`docs/daily/2025-08-26.md`) に貼り付け、運用記録として残してください。