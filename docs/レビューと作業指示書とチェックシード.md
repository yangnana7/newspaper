# 1) masterレビュー（要点）

* 今日の差分ログに基づく機能追加は以下の通り：Entity upsertの衝突回避強化、イベント抽出（type\_id/地理/geohash/参加者ロール）、APIフィルタ拡張、Wikidata連携の信頼度・レート制御・再開、言語判定、メトリクス追加、日次ログ更新。該当箇所は作業ログに明示されています（L4–L11、L14–L16）。
* 外部IDリンクの信頼度・再実行設計は設計メモにも方針が反映済み（`min_confidence`やブラックリスト語、進捗ファイル運用）。
* イベント分類（1000/1100/1200/1300/9999）と参加者ロールJSON形式は設計メモに定義。
* 監視メトリクスは `entities_linked_total` / `events_with_participants_total` を含めて文書化済み。
* 「MCP-First」運用と公開I/Fの最小化（既定UI無効）はマニュアルに準拠。

結論：MCP層の基盤は着実に前進。イベント抽象とEL精度は継続育成（スプリント3の主戦場）という元設計のロードマップ通りです。

---

# 2) CodexCLI 正式作業指示書（2025-08-28）

**目的**：本日の着地＝「CIグリーン維持」「設計メモの到達点をテストで担保」「運用可視化の最小一式」。
**前提**：`DB=newshub`、`127.0.0.1:3011`固定、MCP-Firstポリシー厳守。

### A. 依存 & CIの堅牢化

1. **dev依存の網羅**
   `requirements-dev.txt` に次を含める：`pytest`, `pytest-asyncio`（または非依存で統一）, `prometheus-client`, `langdetect`, `pyyaml`, `requests`, （使っていれば）`geohash2`。
   受入：`pip install -r requirements.txt && pip install -r requirements-dev.txt` がCIで通る。
2. **CI環境変数固定**
   `.github/workflows/ci.yml` に `SKIP_DB_TESTS=1` を追加し、DB依存テストをskip。進捗ファイル等の書込先は `PROGRESS_FILE=$RUNNER_TEMP/linking.progress` を指定。
   受入：PR/PushでCI緑（0 failed / 0 error）。

### B. 外部IDリンク（Wikidata）実装の最終化

1. **設定ファイルの標準化**
   `config/linking.yaml` に `min_confidence`, `blacklist_keywords`, `requests_per_sec`, `max_retries`, `prefer_lang`, `progress_file` を定義（既存値の見直し）。設計メモ準拠。
2. **信頼度選別ロジック**
   `scripts/link_entities_wikidata.py`：`match.type=exact`を優位、説明の曖昧語は減点、閾値未満は不採用（実装済の確認）。受入：`grep -q 'confidence' scripts/link_entities_wikidata.py` が真。
3. **メトリクス加算**
   成功時 `entities_linked_total++` を確認。受入：`curl 127.0.0.1:3011/metrics` にカウンタが出る。

### C. イベント抽出・登録の到達保証

1. **抽出ロジック**
   `scripts/event_extract.py`：タイプ分類（1000/1100/1200/1300/9999）、地名→`loc_geohash`、参加者 `{name, role}`（実装済の確認）。受入：`grep -q 'type_id' ... && grep -q 'loc_geohash' ... && grep -q 'role' ...` が真。
2. **登録パス**
   `scripts/ingest_events.py`：参加者ありイベントで `events_with_participants_total++` を加算。受入：メトリクス文書の想定名に一致。
3. **APIフィルタ**
   `mcp_news/server.py` の `event_timeline` に `participant_ext_id` / `loc_geohash` フィルタがあること（実装済確認）。受入：`grep -q 'participant_ext_id' mcp_news/server.py`。

### D. 言語判定とランキング反映

1. **スクリプト存在**
   `scripts/set_language.py`（`detect_lang`/`set_missing`）の存在とテスト追加。受入：`test -f scripts/set_language.py && echo OK`。
2. **テスト**
   `tests/test_language_detection.py` を `SKIP_DB_TESTS=1` で実行。受入：`0 failed`（DB不要）。

### E. ドキュメント更新

* `docs/design/entity_event_plan.md`, `docs/ops/metrics.md`, `docs/daily/2025-08-28.md` の更新反映を確認。受入：各ファイルの該当追記があること。

> **実行順（CodexCLI）**：A → B → C → D → E。失敗ログはそのまま食わせて反復修正（この開発様式は設計v2で推奨）。

---

# 3) チェックシード（CodexCLI本日版）

| No | 項目              | コマンド/証跡                                                  | 期待値      |  重み | 状態   |
| -: | :-------------- | :------------------------------------------------------- | :------- | :-: | :--- |
|  1 | Wikidata信頼度実装   | `grep -q 'confidence' scripts/link_entities_wikidata.py` | 実装あり     |  8  | \[ ] |
|  2 | Entity upsert改修 | `grep -q 'ON CONFLICT' scripts/ingest_entities.py`       | 実装あり     |  5  | \[ ] |
|  3 | upsertテスト       | `pytest -q tests/test_entity_upsert.py`                  | 0 failed |  8  | \[ ] |
|  4 | イベントtype判定      | `grep -q 'type_id' scripts/event_extract.py`             | 実装あり     |  7  | \[ ] |
|  5 | 場所/ロール抽出        | `grep -q 'loc_geohash' ... && grep -q 'role' ...`        | 2箇所hit   |  7  | \[ ] |
|  6 | イベント分類テスト       | `pytest -q tests/test_event_classification.py`           | 0 failed |  8  | \[ ] |
|  7 | APIフィルタ拡張       | `grep -q 'participant_ext_id' mcp_news/server.py`        | 実装あり     |  5  | \[ ] |
|  8 | 言語判定スクリプト       | `test -f scripts/set_language.py && echo OK`             | OK       |  5  | \[ ] |
|  9 | 言語判定テスト         | `pytest -q tests/test_language_detection.py`             | 0 failed |  6  | \[ ] |
| 10 | 新メトリクス定義        | `grep -q 'entities_linked_total' mcp_news/metrics.py`    | 実装あり     |  5  | \[ ] |
| 11 | CI dev依存        | `grep -q 'langdetect' requirements-dev.txt`              | ヒット      |  5  | \[ ] |
| 12 | 日次ログ            | `git ls-files docs/daily/2025-08-28.md`                  | 存在       |  5  | \[ ] |
| 13 | ポリシー維持          | `pytest -q tests/test_ci_env.py`                         | 0 failed |  4  | \[ ] |

※達成率＝✔の重み合計/合計100。上の表・達成基準は指示書に合致（文書にも同形式が記載）。

---

## ひとこと

この運びでOKです。CodexCLIは上記A→Eの順にガンガン回してください。CIが赤になったらログ断片をそのまま貼り付け—A/Bのどこでコケたかを即座に特定できる構成にしてあります（依存→リンク→イベント→言語→ドキュメント）。
メトリクス／Grafanaは既に導線があるので、最後に `/metrics` を軽く見るのを忘れずに。
