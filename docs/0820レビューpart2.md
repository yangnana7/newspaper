了解。受領した `newspaper.zip` を**静的チェック**で洗いました（DBが無くても確認できる範囲）。結論と優先修正だけ、短く要点で。

---

# 結論（Day-1レビュー）

* **Pythonコードは構文上は通る**（`compileall` 相当OK）。
  ただし **MCPサーバはまだ実運用には未達**：

  * `mcp_news/server.py` が **`mcp.run()` のまま**（stdioに非対応）。
  * **`embedding_space` フィルタが未実装**（意図しないベクトル空間混在の恐れ）。
* **systemdユニット**は最低限動くが、**同時実行ガード（flock）や.envの統一管理が未反映**。
* **RSSのURL正規化**は `utm_*` 除去のみ。**`gclid/fbclid` 等は未除去**。
* **依存ピン止めなし**（運用でハマりやすい）。

> つまり「**ソース→チャンク→埋め込み→検索**」の配線は揃ったが、**サーバ公開まわりの仕上げ**が残ってます。

---

# いますぐ当てる最小パッチ（抜粋）

## 1) MCPサーバ（`mcp_news/server.py`）

* 変更点：

  * `EMBED_SPACE` を固定（envで上書き可）
  * 検索SQLに `embedding_space=%s` を追加
  * **`mcp.run_stdio()` へ変更**（stdio transport）

```python
# 冒頭付近に追記
EMBED_SPACE = os.getenv("EMBED_SPACE", "bge-m3")

# 近傍検索SQL例（sinceフィルタは任意）
sql = f"""
SELECT d.doc_id, d.title_raw, d.published_at,
       (SELECT val FROM hint WHERE doc_id=d.doc_id AND key='genre_hint') AS genre_hint,
       d.url_canon
FROM chunk_vec v
JOIN chunk c ON c.chunk_id = v.chunk_id
JOIN doc   d ON d.doc_id   = c.doc_id
WHERE v.embedding_space = %s
{ "AND d.published_at >= %s" if since_dt else "" }
ORDER BY v.emb <-> %s
LIMIT %s
"""
params = [EMBED_SPACE] + ([since_dt] if since_dt else []) + [q_emb, top_k]

# 終端
if __name__ == "__main__":
    mcp.run_stdio()
```

> 補足：psycopg で Python の `list[float]` を vector型に渡すため、**`pgvector.psycopg.register_vector(conn)`** は既に `db.py` でOK。

## 2) RSS正規化（`scripts/ingest_rss.py`）

* トラッカーパラメータ拡張：

```python
DROP_KEYS = {"utm_source","utm_medium","utm_campaign","utm_term","utm_content","gclid","fbclid"}

def canonicalize_url(url: str) -> str:
    u = urlparse.urlparse(url)
    q = [(k, v) for (k, v) in urlparse.parse_qsl(u.query, keep_blank_values=False) if k.lower() not in DROP_KEYS]
    return urlparse.urlunparse((u.scheme, u.netloc, u.path, u.params, urlparse.urlencode(q), ""))
```

## 3) pgvectorインデックス（`db/schema_v2.sql`）

* **HNSW** と **genre\_hintの部分索引**を有効化：

```sql
-- Cosを使わずL2で行く場合（埋め込みはnormalize=True/Falseどちらでも並びは単調です）
CREATE INDEX IF NOT EXISTS idx_chunk_vec_hnsw_bge_m3
  ON chunk_vec USING hnsw (emb vector_l2_ops)
  WHERE embedding_space='bge-m3';

CREATE INDEX IF NOT EXISTS idx_hint_genre ON hint (doc_id) WHERE key='genre_hint';
CREATE INDEX IF NOT EXISTS idx_entity_ext ON entity (ext_id);
```

## 4) 埋め込みサービスの同時実行ガード（`deploy/embed.service`）

* flock とランタイムディレクトリを追加：

```ini
[Service]
Type=oneshot
RuntimeDirectory=mcp-news
Environment=DATABASE_URL=postgresql://localhost/newshub
Environment=EMBEDDING_MODEL=intfloat/multilingual-e5-base
Environment=EMBED_SPACE=bge-m3
WorkingDirectory=%h/mcp-news
ExecStartPre=/usr/bin/flock -n /run/mcp-news/embed.lock -c 'true'
ExecStart=%h/mcp-news/.venv/bin/python scripts/embed_chunks.py --space ${EMBED_SPACE} --batch 128
```

## 5) 依存の下限ピン（`requirements.txt`）

```txt
mcp>=1.0.0
psycopg[binary]>=3.2.1
pgvector>=0.2.5
feedparser>=6.0.11
pydantic>=2.7.0
sentence-transformers>=2.7.0
httpx>=0.27.0
```

---

# DBが無くても今できる“静的チェック”コマンド

> ローカルで一気に実行して、残タスクの洗い出しだけ進められます。

```bash
# 1) 構文検査
python -m compileall -q newspaper

# 2) mcp.run 検出（stdio化漏れの検知）
rg -n "mcp\.run\(" newspaper

# 3) embedding_space フィルタ漏れの検知（サーバ）
rg -n "embedding_space" newspaper/mcp_news/server.py

# 4) URL正規化のトラッカーパラメータ確認
rg -n "utm_|gclid|fbclid" newspaper/scripts

# 5) 依存の未ピン検出（== が一つも無いならOKだが、>= へ差し替え推奨）
cat newspaper/requirements.txt
```

---

# あなたの「3つの問い」への回答

* **NewsAPI/HN の `canonicalize_url` をRSS版に合わせる？** → **Yes**（同一ロジック化してください）。
* **`EMBED_SPACE` をサービス/envで統一？** → **Yes**（`embed.service` と `mcp-news.service` に `Environment=EMBED_SPACE=bge-m3` を追記）。
* **`README_UBUNTU` のコードフェンス整理？** → **Yes**（初学者が詰まるポイント。env例と `systemctl --user` か `sudo systemctl` かも明記）。

---

# Day-1の「完了」判定（更新）

* `schema_v2.sql` をDBへ反映できる状態（SQLがエラー無し）。
* `ingest_rss.py` → `embed_chunks.py` が単体で通る（DB無しでも構文OK）。
* `mcp_news.server` が **`mcp.run_stdio()`** を使い、`EMBED_SPACE` でフィルタ可能。
* `requirements.txt` の下限ピン完了。
* `deploy/*.service` に **flock と EMBED\_SPACE** を反映。

---

上記パッチを**ファイル丸ごと置換版**（`server.py` / `ingest_rss.py` / `schema_v2.sql` / `embed.service`）で出します。そのまま貼り替え→`compileall`→終わり、まで持っていきます。
