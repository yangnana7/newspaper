# CodexCLI 作業指示書（2025-08-23 / MCPニュースペーパー）

目的：Day1/Day2の到達点を前提に、検索品質・運用性を1段引き上げる。具体的には「ランク融合の導入」「インデックス拡充」「フィードテンプレ追加」「多言語スタブの最小拡張」「テスト拡張」「ドキュメント追記」を今日やり切る。根拠は Day1/Day2 最終報告と設計v2・再開マニュアルに拠る（cos統一、`vector(768)` 固定、CIグリーン、次タスク指針） 。  &#x20;

---

## 前提（環境/制約）

* PostgreSQL 16＋pgvector、Python 3.11、Ubuntu 22.04/24.04。DBはUTC保存、API/MCPはJST表現でよい。&#x20;
* ベクトル距離は cos に統一、`chunk_vec.emb` は `vector(768)`、HNSW索引あり。フォールバックは新着順で常に成立。
* 作業ブランチ：`feat/rank-fusion-and-indexes-day3`

---

## 着手順序（厳守）

A → B → C → D → E → F（テストは適宜）。ランク融合は設計v2の指針（cos×recency×source）に沿う。

---

## タスクA：ランク融合（semantic\_search 再ランク）

**目的**：cos類似（近傍K）に新鮮度・ソース重みを加え、総合スコアで並べ替え。
**実装**：

1. 近傍取得は既存の cos 距離に依存（cos統一はDay2で確定）。
2. 再ランク式（デフォルト）：`Score = 0.7*cos + 0.2*recency_decay(Δt) + 0.1*source_trust`。係数/半減期は環境変数で変更可（例：`RANK_ALPHA/BETA/GAMMA`, `RECENCY_HALFLIFE_HOURS`）。式の形は設計v2に準拠。
3. source\_trust は当面 `{default:1.0}`、将来 `.env` で per-source を渡す。
4. 例外時（ベクトル未ロード/DB例外）は現行どおり「新着順フォールバック」を維持。
   **受入**：

* 既存テストを壊さないこと（CIグリーン継続）。
* ダミーデータで `RECENCY_HALFLIFE_HOURS=1` に設定時、直近文書が上位へ押し上がることを新規テストで確認。

---

## タスクB：DBインデックス拡充（運用系）

**目的**：公開API/MCPの主要クエリに対するI/Oを最小化。
**実装**（冪等で追記）：

* `db/indexes_core.sql` または `db/schema_v2.sql` に以下を追加：

  * `CREATE INDEX IF NOT EXISTS idx_doc_url ON doc (url_canon);`
  * `CREATE INDEX IF NOT EXISTS idx_hint_key ON hint (key);`
    これは前レビューでの指摘事項。
* 既存の HNSW/cos 系インデックスは残置（cos統一はDay2到達点）。
  **受入**：
* スキーマ適用がエラーなく再実行可能（冪等）。
* `/api/*`/MCPの最新順・検索系で実測クエリプランが Index Scan 化（ローカルで `EXPLAIN` 目視）。

---

## タスクC：フィードテンプレ整備（日本向けサンプル）

**目的**：RSS中心の一次情報統合を素早く拡張可能にする。設計v1の方針に合致。
**実装**：

* `config/feeds.sample.json` を追加（NHK総合/大分合同/主要テック各1など、重複は避ける）。
* `scripts/ingest_rss.py` が `--feeds` で当該JSONを読めることを README/RESUMEに明記。
  **受入**：
* ローカルで1巡取り込みが終わり `doc` 件数が増加すること（RESUMEマニュアルの手順に沿って確認）。

---

## タスクD：Entity Link スタブの最小多言語拡張

**目的**：EN以外（ja等）でのmention種別増強。将来のQID連携へ橋渡し（設計v2のEL路線）。
**実装（暫定）**：

* カタカナ連続語・全角アルファベット・ハッシュタグ（`#...`）を追加検出し、`entity(kind='surface', ext_id IS NULL)` を upsert、`mention.conf` を低スコア（0.3）で保存。
* 既存の挙動（英大文字英数字抽出）は保持。
  **受入**：
* 日本語タイトル/本文のダミーchunkに対し、少なくとも1件の `mention` が生成される pytest を追加。
* 既存 `tests/test_entity_stub.py` と両立しCIグリーン維持。

---

## タスクE：テスト拡張

**目的**：検索のフォールバック／再ランク／スタブ拡張の回帰を防ぐ。
**実装**：

* `tests/test_rank_fusion.py`：

  * ダミー3文書（古/中/新）＋同一cosの近傍条件を作り、`RECENCY_HALFLIFE_HOURS` の違いで順位が変わることを確認。
* `tests/test_entity_stub_ja.py`：

  * カタカナ語/ハッシュタグで `mention` が出ること。
* 既存の「q無しでフォールバック」が維持される確認（Day2報告の要件）。
  **受入**：CIグリーン継続。

---

## タスクF：ドキュメント追記

**目的**：再開手順の最短経路を維持しつつ、今日の差分を反映。
**実装**：

* `docs/RESUME_MANUAL.md` に「ランク融合の係数/env」「feeds.sample.json の使い方」を追記。
* `docs/FINAL_REPORT_DAY2.md` の“今後”節に「再ランク導入済/多言語スタブ暫定対応/汎用Index追加済」を追記。

---

## 実行コマンド（ローカル検証）

* 取り込み→埋め込み→MCP（またはHTTP）→pytest の順で一気通し（再開マニュアルの手順を踏襲）。

---

## Done/Exit 条件

* CI グリーン（既存＋新規テスト）。
* ベクトル検索は cos 前提を崩さず（`vector(768)`・HNSW前提を維持）、再ランクが有効化。
* feeds サンプルで ingest が1巡通る（件数増）。
* ドキュメント更新反映（再開が5分でできる）。

---

## 提出物

* コード差分（A〜E）＋ドキュメント差分（F）。
* PR本文：目的/背景（設計v2・Day1/Day2の根拠）、変更点、テスト結果スクリーン、運用影響（env変数新增）を明記。&#x20;
