本日（2025‑08‑24）の改善内容を反映した上で、次のステップに進むための作業指示書とチェックシートを用意します。
以下の指示は **DB名は newshub、待受は 127.0.0.1:3011、距離関数は cosine** という固定ルールを厳守します。

---

# 作業指示書

## 0) 目的（概要）

1. **統合テストとCI整備**：今回追加したメトリクス共通モジュールや非同期デコレータの動作を自動テストで保証する。
2. **性能評価と監視改善**：HNSWインデックスの効果測定とGrafanaダッシュボードサンプルを準備し、メトリクス監視を実用化する。
3. **実体リンクと事象抽出の基礎準備**：将来の機能拡張に備え、固有表現リンクとイベント抽出のスケルトンコードとテーブル定義を作成する。
4. **ドキュメントと運用ログ**：改善内容をまとめ、作業ログと運用ドキュメントを更新する。

## 1) 統合テスト＆CI整備

### 1-1. 統合テストの追加

* 作成: `tests/test_metrics_integration.py`

  * `import web.app` と `import mcp_news.server` を順不同で実行し、`prometheus_client.CollectorRegistry` の重複登録エラーが発生しないことを確認する。
  * `get_metrics_content()` の返り値が文字列で、`# HELP` を含むことを確認する。
* 作成: `tests/test_metrics_async.py`

  * `@time_ingest_operation_async`／`@time_embed_operation_async` デコレータ付きのダミーasync関数を走らせ、メトリクスが正常に記録されることを確認する。
* 作成: `tests/test_ci_env.py`

  * `.env`や`/etc/default/mcp-news`が読み込まれていると仮定し、`APP_BIND_HOST`=`127.0.0.1`、`APP_BIND_PORT`=`3011`、`DATABASE_URL`に`/newshub`が含まれることを確認する。

### 1-2. CIパイプラインの追加

* ファイル: `.github/workflows/ci.yml`

  * Ubuntu 24.04でPython 3.11をセットアップ。
  * `pip install -r requirements.txt` 実行後、`pytest` を全てのテストで実行。
  * テストが失敗した場合はジョブを失敗させる。

## 2) 性能評価と監視改善

### 2-1. ベンチマークスクリプト

* 作成: `scripts/benchmark_search.py`

  * `psycopg` で `chunk_vec` に対し同一クエリを HNSWインデックスあり／なしで実行し、平均応答時間を比較。
  * 例えば100回検索し、結果を標準出力にJSON形式で出力する。
  * 結果は `/docs/performance/2025-08-25-benchmark.md` に記録。

### 2-2. Grafanaダッシュボード例

* 作成: `grafana/dashboard.json`

  * `items_ingested_total`、`embeddings_built_total`、`ingest_duration_seconds`、`embed_duration_seconds` を表示する簡易ダッシュボードの定義を含める。
  * ドキュメント: `docs/ops/grafana.md` にインポート手順と推奨PromQLクエリを記述。

### 2-3. メトリクスの使用例更新

* 取り込みスクリプトや埋め込みスクリプトに、`mcp_news.metrics` のデコレータとカウンタ呼び出しを適用する例を追記する。
* 運用ガイド `docs/ops/metrics.md` に、非同期関数での使用例を追加する。

## 3) 実体リンク＆事象抽出の基礎準備

### 3-1. 実体リンク（エンティティリンク）スケルトン

* 作成: `scripts/entity_link.py`

  * 記事本文から人名・組織名などを抽出する仮の関数 `extract_entities(text: str) -> List[str]` を定義。
  * Wikidata APIやspaCyへの具体的な実装は未定義とし、後続タスクで肉付けする。
  * `entity`・`mention`テーブルに挿入するためのSQL雛形をコメントで記載。

### 3-2. 事象抽出（イベント抽出）スケルトン

* 作成: `scripts/event_extract.py`

  * 記事本文から日時・場所・アクターを抽出し、`event`と`event_participant`テーブルに登録する関数 `extract_events(text: str) -> List[Dict[str,Any]]` を定義。
  * ロジックは未実装（`pass`）とし、必要なカラム名や返り値形式をコメントする。

### 3-3. テーブル定義の検討メモ

* ドキュメント: `docs/design/entity_event_plan.md`

  * エンティティリンク・イベント抽出の今後の設計方針を記述（例: 外部IDの扱い、type\_idの分類、抽出ツール候補など）。

## 4) ドキュメントと作業ログ

* 新規: `docs/daily/2025-08-25.md`

  * 本日のタスク指示書の要約、追加ファイル一覧、残課題などを記録。
* 更新: `docs/ops/metrics.md` に非同期デコレータとGrafanaダッシュボードの項を追記。
* 更新: `docs/daily/2025-08-24-improvements.md` に今回の指示書を参照するリンクを追加。

---

# 作業達成確認チェックシート

| 項目                  | 実施   | エビデンスコマンド                                       | 期待値       | 重み(%) |
| ------------------- | ---- | ----------------------------------------------- | --------- | ----: |
| 統合テスト追加             | \[ ] | `pytest -q tests/test_metrics_integration.py`   | 全テストパス    |    15 |
| 非同期デコレータテスト         | \[ ] | `pytest -q tests/test_metrics_async.py`         | 全テストパス    |    10 |
| CIワークフロー作成          | \[ ] | `git ls-files .github/workflows/ci.yml`         | パス表示      |     5 |
| ベンチマークスクリプト         | \[ ] | `python scripts/benchmark_search.py --runs 50`  | JSON出力    |    10 |
| Grafanaダッシュボード      | \[ ] | `test -f grafana/dashboard.json && echo OK`     | `OK`      |     5 |
| entity\_linkスケルトン   | \[ ] | `test -f scripts/entity_link.py && echo OK`     | `OK`      |    10 |
| event\_extractスケルトン | \[ ] | `test -f scripts/event_extract.py && echo OK`   | `OK`      |    10 |
| 設計メモ作成              | \[ ] | `git ls-files docs/design/entity_event_plan.md` | パス表示      |     5 |
| 日次ログ更新              | \[ ] | `git ls-files docs/daily/2025-08-25.md`         | パス表示      |     5 |
| Grafana文書更新         | \[ ] | `grep -q '非同期' docs/ops/metrics.md && echo OK`  | `OK`      |     5 |
| 環境固定テスト             | \[ ] | `pytest -q tests/test_ci_env.py`                | 全テストパス    |     5 |
| CIテスト通過             | \[ ] | GitHub Actions の結果                              | all green |    15 |

進捗率の計算例：各項目の達成フラグ（✓=1, ×=0）×重みの合計値。

---

## ロールバック手順（簡潔）

1. 新規ファイル削除: `git rm -rf scripts/entity_link.py scripts/event_extract.py grafana/dashboard.json docs/design/entity_event_plan.md` 等。
2. CI設定撤回: `git rm .github/workflows/ci.yml`
3. 既存ファイル復元: `git checkout HEAD~1 -- tests/` など。
4. `/docs/daily/2025-08-25.md` にロールバック理由を記載。

---

## 注意事項

* すでに修正済みの項目（`DATABASE_URL`デフォルト修正、メトリクス共通化、非同期デコレータ追加、環境ファイル確認）は**手を加えない**ようにしてください。
* DB名、ポート、距離関数は固定値で変更禁止です。
* entity/event抽出ロジックは未実装のスケルトンでよく、内容は後続タスクで拡張します。

この指示書とチェックシートに基づき、次のステップを進めてください。必要であれば作業ログに貼り付けて運用記録として残してください。
