# 2025-08-28 作業ログ

## 本日の変更概要
- Entity upsert: `scripts/ingest_entities.py` に `ON CONFLICT DO NOTHING` を用いた重複回避を実装（式インデックスに対応）。
- Event抽出強化: `scripts/event_extract.py` に type_id のキーワード分類、主要都市の geohash 付与、参加者 `{name, role}` 形式を追加。
- Event登録: `scripts/ingest_events.py` で `loc_geohash` 登録と参加者ロール対応、メトリクス記録を実装。
- API拡張: `mcp_news/server.py` の `event_timeline` に `participant_ext_id`/`loc_geohash` フィルタ、`entity_search` に name 検索を追加。
- Wikidata連携: `scripts/link_entities_wikidata.py` に信頼度（confidence）計算、rate-limit/再試行、進捗ログを実装。`config/linking.yaml` 追加。
- 言語判定: `scripts/set_language.py` 追加（langdetect + ヒューリスティック）。
- メトリクス: `mcp_news/metrics.py` に `entities_linked_total` と `events_with_participants_total` を追加し、利用箇所でインクリメント。
- ドキュメント: 設計メモとメトリクス運用メモを更新。

## 追加テスト
- `tests/test_entity_upsert.py`（DB依存、SKIP_DB_TESTS=1 でskip）
- `tests/test_event_classification.py`
- `tests/test_language_detection.py`

## CI/テスト結果（ローカル）
- ランタイム制限のため一部DB依存テストはskip可能。ユニットテストはローカルでパス。

## 次のTODO候補
- 参加者ロール推定の精緻化（発話/主体抽出）
- 地名辞書拡充と曖昧性解消（gazetteer/地理API連携）
- UI `/api/events` の簡易タイムライン表示
