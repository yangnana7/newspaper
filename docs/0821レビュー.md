patch approval decision: Approved

✏️ Applying patch

📋 Updated to do list [██████████] 5/5
note
Reviewed 0820レビューpart2.md and applied the additional requested changes (EMBED_SPACE env unification, stricter URL canonicalization for NewsAPI/HN, embed.service improvements).
  ⎿ ✔ Read all docs/*.md for context
    ✔ Explore source code structure
    ✔ Extract actionable items from 0820レビュー.md
    ✔ Implement changes per review
    ✔ Read part2 review and batch files

codex
I read 0820レビューpart2.md and the batch files under docs/batch, then aligned t               
he codebase with the requested adjustments.                                                    
                                                                                               
**What I Verified**                                                                            
- Part2 focus: embedding_space filter + stdio transport, stricter URL canonicali               
zation, HNSW + helper indexes, service lock + env unification, and dependency pi               
ns.                                                                                            
- Batch contents provide full-file examples for server, schema, embed.service, a               
nd RSS ingest; our repo now reflects those intents.                                            
                                                                                               
**Applied Changes**                                                                            
- Server                                                                                       
  - `embedding_space` filter: uses `EMBED_SPACE` (default `bge-m3`) and filters                
vector search by space.                                                                        
  - Transport: switches to `mcp.run_stdio()`.                                                  
  - File: `mcp_news/server.py`                                                                 
                                                                                               
- Schema                                                                                       
  - HNSW index for `bge-m3` and helper indexes for `hint` and `entity.ext_id`.                 
  - File: `db/schema_v2.sql`                                                                   
  - Note: I kept `CREATE EXTENSION` commented to avoid failures on systems witho               
ut the package; install via README steps as before.                                            
                                                                                               
- Services                                                                                     
  - Embed job: adds `RuntimeDirectory` + `flock` lock, unifies `EMBED_SPACE` env               
, and uses it in `ExecStart`.                                                                  
  - Server unit: adds `Environment=EMBED_SPACE=bge-m3`.                                        
  - Files: `deploy/embed.service`, `deploy/mcp-news.service`                                   
- Ingest Canonicalization
  - NewsAPI/HN: upgraded `canonicalize_url` (drop fragments and `utm_*`, `gclid`
, `fbclid`, etc.) to match RSS logic.
  - Files: `scripts/ingest_newsapi.py`, `scripts/ingest_hn.py`
  - RSS: previously strengthened; retained.

- Dependencies
  - Lower-bound pins for stability.
  - File: `requirements.txt` (docs/requirements.txt already matched)

**Notes on Batch vs. Repo**
- Batch `schema_v2.sql` includes `CREATE EXTENSION IF NOT EXISTS vector;` and an
 `author` column. Our schema omits the extension creation (setup is done separat
ely) and the `author` column (not required by current scripts). If you want, I c
an add the `author` column with no downstream changes needed.

**Next Steps**
- Re-apply schema for indexes: `psql ... -f db/schema_v2.sql`.
- Re-run ingest and embedding: RSS/NewsAPI/HN → `embed_chunks.py --space bge-m3`
.
- Start MCP: ensure `DATABASE_URL`, `ENABLE_SERVER_EMBEDDING=1`, and `EMBED_SPAC
E=bge-m3` set; run `python -m mcp_news.server`.
- Optional: want me to add `CREATE EXTENSION` lines to the schema (as in batch)
and/or add `author` to `doc`?

レビューOK。全体として「Day-1→Day-2へ進める状態」になっています。差分の要点と、**GitHubへ引っ越し直後に即グリーンにできるCI/テスト雛形**を用意しました。

---

## 👌 実装レビュー（今回報告分）

### 合格点（方向性）

* `embedding_space` フィルタ＋`mcp.run_stdio()`：**必須2点は反映済み**。
* URL canonicalize の統一（RSS/NewsAPI/HN）：**OK**。
* HNSW＋部分インデックス（`hint`/`entity.ext_id`）：**OK**。
* `embed.service` の `flock`＋`EMBED_SPACE` 環境統一：**OK**。
* 依存ピン（下限）：**OK**。CIでの解決性が上がる。

### 追加提案（軽微）

* **`CREATE EXTENSION vector` をスキーマに残す**（`IF NOT EXISTS` で安全）。CI と新人環境が楽になります。
  → 以降のCI雛形で **pgvector入りの Postgres** を起動し、`CREATE EXTENSION IF NOT EXISTS vector;` を流す運用にしています。
* `doc.author` 列は**任意**（MVPでは不要）。将来の「媒体別品質評価」スコアリングに使うなら追加推奨（互換性壊さずADD可）。

---

## ✅ 明日からのGit移行に向けたCIテンプレ

GitHub Actions の**即動く雛形**と**スモークテスト**を作りました。
リポジトリのルートに配置すれば、そのまま**緑が点く**構成です。

**ダウンロード**：
[CI pack（ZIP）](sandbox:/mnt/data/ci_pack.zip)

**内容**

```
.github/workflows/ci.yml        # CI本体（pgvector入りPostgresをサービス起動）
tests/test_smoke.py             # DB作成→doc/chunk投入→doc_head/semantic_searchの疎通
tests/test_urlcanon.py          # canonicalize_url の回帰テスト
```

### 1) .github/workflows/ci.yml の要点

* **Postgresサービス**：`pgvector/pgvector:pg16` を使用（拡張同梱）
* `CREATE EXTENSION IF NOT EXISTS vector;` を最初に実行
* `db/schema_v2.sql` を適用
* `compileall` で構文チェック → `pytest` でスモーク
* `ENABLE_SERVER_EMBEDDING=0`（CIはベクトルなしでも**recency fallback**で通る）

### 2) tests/test\_smoke.py の要点

* スキーマの**存在チェック**（`doc/chunk/chunk_vec/hint`）
* **1件だけ** `doc` と `chunk` を挿入
* `mcp_news.server.doc_head()` と `semantic_search()` を**直接コール**し、
  **MCPラッパ無しでも**DB越しに結果が得られることを確認

### 3) tests/test\_urlcanon.py

* トラッカーパラメータ（`utm_*`, `gclid`, `fbclid`）が除去されることの回帰

---

## 📦 レポート差異への回答

> 「`CREATE EXTENSION` をスキーマに入れる？」「`author` を足す？」

* **CREATE EXTENSION**：**入れるのを推奨**（`IF NOT EXISTS` 付き）。

  * CIでは pgvector 付きDockerを使うので**常に成功**
  * ローカルでも pgvector 未導入なら **失敗せずスキップ** させたい場合はスキーマから外すのも可。ただしCIと新人環境の手間が増えます
* **author 列**：**後方互換でいつでも追加可**。現行スクリプト非依存なので**当面不要**。

---

## 🧭 Git引っ越しチェックリスト（最短版）

1. **リポ作成** → `main` ブランチ保護（PR必須）
2. ルートに以下を追加/更新

   * `requirements.txt`（現行）
   * `db/schema_v2.sql`（`CREATE EXTENSION IF NOT EXISTS vector;` を**入れる運用**がおすすめ）
   * `.github/workflows/ci.yml`（上のZIPから）
   * `tests/`（上のZIPから）
3. **Secretsは不要**（CIは公知フィードも不使用、DBはサービス内）
4. **プッシュ** → PR 作成 → **CIグリーン**を確認

> ※ 将来 NewsAPI 等のE2Eを回したくなったら、別ジョブを切って `NEWSAPI_KEY` を `Actions secrets` に入れる運用にしましょう（現スモークは鍵不要）。

---

## 🔧 仕上げの微差分（任意で追記OK）

* `db/schema_v2.sql` に次を追記（品質）

  ```sql
  CREATE INDEX IF NOT EXISTS idx_doc_url ON doc (url_canon);
  CREATE INDEX IF NOT EXISTS idx_hint_key ON hint (key);
  ```
* `deploy/mcp-news.service` にも `Environment=EMBED_SPACE=bge-m3` を**明示**（embedと揃える）
* 将来Cos類似に切替える場合：

  * DB索引を `vector_cosine_ops` に変更
  * サーバ埋め込みの `normalize_embeddings=True` を維持

---

## 📝 受け入れ基準（Day-2向け更新）

* CI（`ci.yml`）が **main/pull\_requestで緑**
* `semantic_search` が **埋め込み無しでも** リストを返す（fallback通過）
* `canonicalize_url` のテストが**安定グリーン**
* スキーマに `IF NOT EXISTS vector` を含む or CI側で実行（どちらでもOK）

---

必要なら、**`mcp-news.service` の雛形**や **`ingest_newsapi.py / ingest_hn.py` の丸ごと置換版**も続けて出します。今回のCI雛形を入れてプッシュすれば、明日から\*\*Git上の反復（PR駆動）\*\*にスムーズに移行できます。
