## 0821 レビュー part2（実装指示書）

日付: 2025-08-21

### 目的
- Day2 の足場仕上げ。検索の一貫性（cos類似）・最低限のイベント抽出スタブ・CIの堅牢化を行い、リグレッションをテストでカバーする。

### 変更概要（サマリ）
- ベクトル検索を「正規化埋め込み × cos距離」に統一。
- `scripts/event_extract_stub.py` に最小実装（チャンク単位のダミーイベント＋evidence）を追加し、単体テストを用意。
- CI を小堅牢化：依存の明示インストールを追加（`psycopg[binary] pgvector`）。

### 指示（タスク）
1) ベクトル検索の整合性: cos類似へ統一（必須）
   - スキーマ: `db/schema_v2.sql` に HNSW の cos 用 opclass を追加。
     - `CREATE INDEX IF NOT EXISTS idx_chunk_vec_hnsw_bge_m3_cos ON chunk_vec USING hnsw (emb vector_cosine_ops) WHERE embedding_space='bge-m3';`
     - 既存の L2 用インデックスは残してよい（後で移行時にDROP）。
   - サーバ: `mcp_news/server.py` の `semantic_search` を cos 距離に変更。
     - `ORDER BY v.emb <=> %s` を使用（`_MODEL.encode(..., normalize_embeddings=True)` は現状維持）。
   - 期待効果: 正規化ベクトルと距離演算子・索引の整合が取り、将来の品質回帰を避ける。

2) イベント抽出スタブ（最小）
   - `scripts/event_extract_stub.py` にダミー実装を追加。
     - 未処理の `chunk` について 1:1 で `event`（`type_id='stub:event'`）を作成し、`evidence` を張る。
     - 今回は日付/場所抽出は行わず、`t_start/t_end` はNULLでよい。
   - テスト: `tests/test_event_stub.py`
     - ダミーの doc+chunk を作り、スタブ実行で `event` と `evidence` が1件以上作成されることを確認。

3) CI 強化
   - `.github/workflows/ci.yml` の Python 依存インストールで、`pip install psycopg[binary] pgvector` を追加（`requirements.txt` の漏れに対する保険）。

4) ドキュメント
   - `README.md` または `docs/FINAL_REPORT.md` の変更履歴に上記の変更点（cos距離統一・イベントスタブ・CI強化）を追記。

### 実施順序（推奨）
1. スキーマに cos インデックス追記 → サーバの演算子を `<=>` に変更。
2. イベント抽出スタブとテストを追加。
3. CI の依存インストールを追記し、CI を実行（テストのグリーン確認）。
4. README/レポートを更新。

### Done 条件
- CI がグリーン。
- `tests/test_event_stub.py` が pass。
- `mcp_news.server.semantic_search` が cos 距離（`<=>`）を使用。
- スキーマに `idx_chunk_vec_hnsw_bge_m3_cos` が存在。

### CI フィードバック対応（追記）
- スキーマ適用時のエラーを解消:
  - `chunk_vec.emb` を `vector(768)` に変更（HNSW/IVFFLAT は列次元が必須）。
  - `hint`/`entity` の補助インデックス作成をテーブル定義後に実行するよう順序を修正。
- pytest 収集時の `ModuleNotFoundError: scripts` を解消:
  - CI のテスト実行を `PYTHONPATH=.` で実行するよう `.github/workflows/ci.yml` を修正。
  - さらに `pytest -q tests` として `docs/ci_pack/tests` は収集対象から除外（重複ファイル名回避）。
